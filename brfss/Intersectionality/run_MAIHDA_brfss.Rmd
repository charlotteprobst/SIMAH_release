---
title: "BRFSS grams per day"
Run MAIHDA on grams per day using BRFSS data
---

Setup
```{r}
# read in data
BRFSS_data <- readRDS("U:\\SIMAH\\SIMAH_workplace\\BRFSS\\BRFSS_upshifted_2000_2020_USA.RDS")

# Load necessary packages
library("R2MLwiN")
library(tidyr)
library(dplyr)

# Bias toward non-scientific notation
options(scipen=10)
```

Data prep
```{r}
# subset drinkers
drinkers_brfss <- BRFSS_data %>% filter(drinkingstatus_detailed == "Monthly drinker" | drinkingstatus_detailed == "Yearly drinker")

# remove years 2019 and 2020 to make comparable to NHIS analysis
drinkers_brfss <- drinkers_brfss %>% filter(YEAR != 2019 & YEAR != 2020)

# drop individuals with estimated 0 grams per day on average
drinkers_brfss <- drinkers_brfss %>% subset(gramsperday_orig !=0)

# Assign all individuals an ID number
drinkers_brfss <- drinkers_brfss %>% mutate(ID = row_number())

# Sex
drinkers_brfss <- rename(drinkers_brfss, SEX = sex_recode)

# Education
drinkers_brfss <- rename(drinkers_brfss, education_3_cats = education_summary)

# Age 3 cats
drinkers_brfss <- drinkers_brfss %>% mutate(
  age_3_cats = dplyr::case_when(
    age_var <= 24 ~ 1, # Adolesents and young adults (18-24)
    age_var > 24 & age_var <=69 ~ 2, # Adults (25-69)
    age_var > 69 ~ 3), # Older adults (70-99)
)

drinkers_brfss$age_3_cats <- factor(drinkers_brfss$age_3_cats,
                                     levels = c(1,2,3),
                                     labels = c("18-24", "25-69", "70+"))

# Decade
drinkers_brfss <- drinkers_brfss %>% mutate(
  decade = case_when(
    YEAR == 2000 | YEAR == 2001 | YEAR == 2002 | YEAR == 2003 | YEAR == 2004 |
    YEAR == 2005 | YEAR == 2006 | YEAR == 2007 | YEAR == 2008 | YEAR == 2009 ~ 1, 
    YEAR == 2010 | YEAR == 2011 | YEAR == 2012 | YEAR == 2013 | YEAR == 2014 | 
    YEAR == 2015 | YEAR == 2016 | YEAR == 2017 | YEAR == 2018  ~ 2))


# Label new categories:
drinkers_brfss$decade <- factor(drinkers_brfss$decade,
                                levels = c(1,2),
                                labels = c("2000-2009","2010-2018"))

# Appears NAs already dropped from data
```

Descriptive stats
```{r}
drinkers_brfss %>% 
  group_by(SEX) %>% 
  count %>% 
  ungroup() %>% 
  mutate(percent=n/sum(n)*100)

drinkers_brfss %>% 
  group_by(education_3_cats) %>% 
  count %>% 
  ungroup() %>% 
  mutate(percent=n/sum(n)*100)

mean(drinkers_brfss$age_var)
drinkers_brfss %>% 
  group_by(age_3_cats) %>% 
  count() %>%
  ungroup() %>% 
  mutate(percent=n/sum(n)*100)

drinkers_brfss %>% 
  group_by(decade) %>% 
  count() %>%
  ungroup() %>% 
  mutate(percent=n/sum(n)*100)

drinkers_brfss %>% 
  group_by(race_eth) %>% 
  count() %>%
  ungroup() %>% 
  mutate(percent=n/sum(n)*100)
```

Review distribution of raw data
```{r}
# check distribution of grams per day amongst drinkers
min(drinkers_brfss$gramsperday_orig)
max(drinkers_brfss$gramsperday_orig)
mean(drinkers_brfss$gramsperday_orig) # 10.4
hist(drinkers_brfss$gramsperday_orig)

# apply cap of 200g
drinkers_brfss <- drinkers_brfss %>% 
  mutate(gramsperday_orig_cap = if_else(gramsperday_orig > 200, 200, gramsperday_orig))

## Review distribution 
hist(drinkers_brfss$gramsperday_orig_cap)
mean(drinkers_brfss$gramsperday_orig_cap) # 10.2

# Transform alcohol data to fit normal distribution
drinkers_brfss <- drinkers_brfss %>% 
  mutate(gramsperday_orig_cap_log = log(gramsperday_orig_cap))

# Review distribution
hist(drinkers_brfss$gramsperday_orig_cap_log) 
```
Raw data has abnormal distribution, even after transformation, therefore review using upshifted data. 

#### ANALYSIS 2: Using upshifted data

```{r}
# replicated dataset for use in analysis 2 to avoid confusion
drinkers_brfss_2 <- drinkers_brfss

# drop individuals with estimated 0 grams per day on average
drinkers_brfss_2 <- drinkers_brfss_2 %>% subset(gramsperday_upshifted !=0)

# check distribution of grams per day amongst drinkers
min(drinkers_brfss_2$gramsperday_upshifted) # 0.69
max(drinkers_brfss_2$gramsperday_upshifted) # 1791
mean(drinkers_brfss_2$gramsperday_upshifted) # 16.5
hist(drinkers_brfss_2$gramsperday_upshifted)

# apply cap of 200g
drinkers_brfss_2 <- drinkers_brfss_2 %>% 
  mutate(gramsperday_upshifted_cap = if_else(gramsperday_upshifted > 200, 200, gramsperday_upshifted))

## Review distribution
hist(drinkers_brfss_2$gramsperday_upshifted_cap)
mean(drinkers_brfss_2$gramsperday_upshifted_cap) # 16.0

# Transform alcohol data to fit normal distribution
drinkers_brfss_2 <- drinkers_brfss_2 %>% 
  mutate(gramsperday_upshifted_cap_log = log(gramsperday_upshifted_cap))

# Review distribution (and compare to non-upshifted)
hist(drinkers_brfss$gramsperday_orig_cap_log)
hist(drinkers_brfss_2$gramsperday_upshifted_cap_log) 
```
Upshifted data slightly better after transformation

# trial alternative transformation
# b <- MASS::boxcox(lm(drinkers_brfss_2$gramsperday_upshifted_cap ~ 1))
# lambda <- b$x[which.max(b$y)] # -0.02 (also suggestive that log transformation best).  However, note very wide CIs around lambda value

Generate intersections and reference tables
```{r}
# Generate intersectional groups
drinkers_brfss_2 <- drinkers_brfss_2 %>% 
  group_by(SEX, race_eth, education_3_cats, age_3_cats, decade) %>% 
  mutate(intersections = cur_group_id()) %>%
  group_by(intersections) %>%
  mutate(count=n())

# Generate reference/summary table of raw intersectional groups data
intersectional_groups <- drinkers_brfss_2 %>%  
  mutate(intersectional_names = as.character(paste(SEX, age_3_cats, race_eth, education_3_cats, decade)))%>%
  group_by(intersections) %>% 
  mutate(percent=count/sum(count)*100,
         mean_observed_grams = mean(gramsperday_upshifted_cap)) %>%
  select(intersections, intersectional_names, age_3_cats, race_eth, SEX, decade, education_3_cats, count, percent, mean_observed_grams) %>%
  distinct()
# Smallest group size is 215 people
```

# Prep data for use with R2mlwin package
```{r}
# Generate a constant
drinkers_brfss_2 <- drinkers_brfss_2 %>%
  mutate(cons=1)

# Sort by intersections
drinkers_brfss_2 <- drinkers_brfss_2 %>% arrange(intersections, ID)

# Save data used for modelling
saveRDS(drinkers_brfss_2, "U:/SIMAH/SIMAH_workplace/BRFSS/Intersectionality/drinkers_brfss.RDS")

# Change file path for mlwin based on computer being used
# options(MLwiN_path="C:/Program Files/MLwiN v3.01/") # Uni
options(MLwiN_path="C:/Program Files/MLwiN v3.05") # home
```

# Specify models
```{r}
# Read in processed data
drinkers_brfss_2 <- readRDS("U:/SIMAH/SIMAH_workplace/BRFSS/Intersectionality/drinkers_brfss.RDS")

# Specify MAIHDA model formula

# Null model
F1 <- gramsperday_upshifted_cap_log ~ 1 + (1 | intersections) + (1 | ID)

# Main-effects model
F2 <- gramsperday_upshifted_cap_log ~ 1 + SEX + age_3_cats + race_eth + education_3_cats + decade + (1 | intersections) + (1 | ID)

```

Note for normal response models the level 1 ID needs to be explicitly included in the random part of the model formula; this is not the case for discrete response models.

## IGLS

# Run the null model and calculate VPC

```{r}
VarCompModelIGLS <- runMLwiN(Formula = F1, 
                             data = drinkers_brfss_2)

VPC_null <- VarCompModelMCMC["RP"][["RP2_var_Intercept"]]/
        (VarCompModelMCMC["RP"][["RP1_var_Intercept"]] + VarCompModelMCMC["RP"][["RP2_var_Intercept"]])*100

within_group_variance_null <- 100-VPC_null
```


# Run the main-effects two-level model (storing residuals) and recalculate VPC
```{r}
VarCompResidIGLS <- runMLwiN(Formula = F2, 
                             data = drinkers_brfss_2, 
                             estoptions = list(resi.store = TRUE, debugmode=TRUE))
```


## MCMC

```{r}
VarCompModelMCMC <- runMLwiN(Formula = F1, 
                             data = drinkers_brfss_2)

VPC_null <- VarCompModelMCMC["RP"][["RP2_var_Intercept"]]/
        (VarCompModelMCMC["RP"][["RP1_var_Intercept"]] + VarCompModelMCMC["RP"][["RP2_var_Intercept"]])*100

within_group_variance_null <- 100-VPC_null
```


```{r}
VarCompResidMCMC <- runMLwiN(Formula = F2, 
                             data = drinkers_brfss_2, 
                             estoptions = list(resi.store = TRUE, EstM = 1))
```



# Default: burn in = 500, iterations = 5000, a thinning factor of 1, a random number seed of 1, 1 chain 
# For fixed parameters MLwiN employs, by default, an improper uniform prior p(β) ∝ 1

# Error in foreign::read.dta(chainfile[i]) : 
#   unable to open file: 'No such file or directory'

# Trial running with IGLS instead

# Warning messages:
#   1: In reset < 0 || reset > 2 :
#   'length(x) = 2 > 1' in coercion to 'logical(1)'
# 2: In reset < 0 || reset > 2 :
#   'length(x) = 2 > 1' in coercion to 'logical(1)'
# 3: In FP[] <- stats::na.omit(estIGLS[, 1]) :
#   number of items to replace is not a multiple of replacement length

VPC_full_IGLS <- VarCompResidIGLS["RP"][["RP2_var_Intercept"]]/
        (VarCompResidIGLS["RP"][["RP1_var_Intercept"]] + VarCompResidIGLS["RP"][["RP2_var_Intercept"]])*100 # 0.8%

within_group_variance_full_IGLS <- 100-VPC_full_IGLS # 99.2%

PCV <- (VPC_null-VPC_full_IGLS)/VPC_null*100 # 90.5%

saveRDS(VarCompResidIGLS, "U:/SIMAH/SIMAH_workplace/BRFSS/Intersectionality/VarCompResidIGLS.RDS")