---
title: "Run MAIHDA analysis"
---

This script undertakes a multi-level analysis of individual heterogeneity and discriminatory accuracy (MAIHDA)
to estimate the number of occassions someone drank 5+ units in the last year.

Analysis is based only on drinkers who drink 5+ at least once

Setup
```{r, warning=FALSE}
# Load in data
transformed_drinkers <- readRDS("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_drinkers_log.RDS")

# Load necessary packages
library("R2MLwiN")
library(tidyr)
library(dplyr)

# Bias toward non-scientific notation
options(scipen=10)

# Change file path ONLY IF using Uni desktop
# options(MLwiN_path="C:\\Program Files\\MLwiN v3.01")
```
Generate intersectional groups
```{r}
data_intersections_MAIHDA <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_3_cats, age_3_cats, decade) %>% 
  mutate(intersections = cur_group_id()) %>%
  group_by(intersections) %>%
  mutate(count=n())
```

Create a reference table of the intersectional groups - numbers and names
```{r}
temp <- data_intersections_MAIHDA %>%
  mutate(sex = dplyr::recode(SEX, Male = "M", Female = "F"),
         race_5_cats = dplyr::recode(race_5_cats, 
                                     "Black/African American" = "Black", 
                                     "Hispanic, White" = "Hispanic"),
         education_3_cats = dplyr::recode(education_3_cats, 
                                          "high school or less" = "low edu.", 
                                          "some college" = "med. edu.", 
                                          "4+ years college" = "high edu."))

temp2 <- temp %>% 
  mutate(intersectional_names = as.character(paste(sex, age_3_cats, race_5_cats, education_3_cats, decade)))

MAIHDA_intersections_reference <- distinct(temp2, intersections, .keep_all = TRUE) %>% dplyr::select(intersections, intersectional_names)
```

Prep data for use with R2mlwin package
```{r}
# Generate a constant
data_intersections_MAIHDA <- data_intersections_MAIHDA %>%
  mutate(cons=1)

# Sort by intersections
data_intersections_MAIHDA <- data_intersections_MAIHDA %>% arrange(intersections)
```

# MAIHDA with MCMC

Review distribution of ALC5UPYR
```{r}
hist(data_intersections_MAIHDA$ALC5UPYR) # highly skewed
```
Descriptive summary of alc5upyr by intersections
```{r}
HED_summary <- data_intersections_MAIHDA %>% group_by(SEX, race_5_cats, education_3_cats, age_3_cats) %>% summarise(Mean = mean(ALC5UPYR)) %>% arrange(desc(Mean))
```
Normalise distribution with a log transformation
```{r}
data_intersections_MAIHDA <- data_intersections_MAIHDA %>% mutate(
  log_ALC5UPYR = (log(ALC5UPYR + 1)))

hist(data_intersections_MAIHDA$log_ALC5UPYR, breaks = 100)
```
# check assumptions using a basic model

Model
```{r}
lm_model_hed <- lm(log_ALC5UPYR ~ age_3_cats + decade + race_5_cats + education_5_cats + SEX, data = data_intersections_MAIHDA)
```

# Check assumptions of basic model

### Heteroskedasicty of residuals
```{r}
plot(fitted(lm_model_hed), resid(lm_model_hed))
abline(h = 0, lty = 2, col = "red")
```
### Check if residuals normally distributed
```{r}
qqnorm(residuals(lm_model_hed))
qqline(residuals(lm_model_hed), col = "steelblue", lwd = 2)

qqnorm(rstandard(lm_model_hed))
qqline(rstandard(lm_model_hed), col = "steelblue", lwd = 2)
```
# FAILING ALL TESTS EVEN AFTER TRANSFORMATION THEREFORE TRYING ONLY WITH PEOPLE WHO REPORT >0 HED OCCASSIONS

Descriptive stats of who reports any occassions of HED
```{r}
temp <- data_intersections_MAIHDA %>% select(SEX, race_5_cats, education_3_cats, age_3_cats,ALC5UPYR) %>%  mutate(HED=(ifelse(ALC5UPYR>0,1,0))) %>% group_by(SEX, race_5_cats, education_3_cats, age_3_cats, HED) %>% count() %>% group_by(SEX, race_5_cats, education_3_cats, age_3_cats) %>% mutate(percent_HEDs=n/sum(n)*100, total_group_size = n/percent_HEDs*100) %>% filter(HED==1) %>% ungroup()

summary_heds <- temp %>% 
  mutate(sex = dplyr::recode(SEX, Male = "M", Female = "F"),
         race_5_cats = dplyr::recode(race_5_cats, 
                                     "Non-Hispanic Black/African American" = "Black", 
                                     "Non-Hispanic White" = "White",
                                     "Non-Hispanic Asian" = "Asian",
                                     "Non-Hispanic Other" = "Other",
                                     "Hispanic, White" = "Hispanic"),
         education_3_cats = dplyr::recode(education_3_cats, 
                                          "high school or less" = "low edu.", 
                                          "some college" = "med. edu.", 
                                          "4+ years college" = "high edu."), 
        intersectional_names = as.character(paste(sex, age_3_cats, race_5_cats, education_3_cats))) %>%
              select(sex, intersectional_names,total_group_size, percent_HEDs)

# plots
summary_heds %>% ggplot(aes(x = intersectional_names, y = percent_HEDs)) +
  geom_bar(stat = "identity") + ylim(0,100) + theme(axis.text.x=element_text(angle=90))
```

Filter only people who HED at least once in the last year

```{r}
HED_DRINKERS <- data_intersections_MAIHDA %>% filter(ALC5UPYR>0)

HED_DRINKERS <- HED_DRINKERS %>% mutate(
  log_ALC5UPYR = (log(ALC5UPYR + 1)))
```

```{r}
hist(HED_DRINKERS$ALC5UPYR)
hist(HED_DRINKERS$log_ALC5UPYR, breaks=100)
```
Model
```{r}
lm_model_hed_only <- lm(log_ALC5UPYR ~ age_3_cats + decade + race_5_cats + education_5_cats + SEX, data = HED_DRINKERS)
```

```{r}
plot(fitted(lm_model_hed_only), resid(lm_model_hed_only))
abline(h = 0, lty = 2, col = "red")
```
### Check if residuals normally distributed
```{r}
qqnorm(residuals(lm_model_hed_only))
qqline(residuals(lm_model_hed_only), col = "steelblue", lwd = 2)

qqnorm(rstandard(lm_model_hed_only))
qqline(rstandard(lm_model_hed_only), col = "steelblue", lwd = 2)
```

Null multilevel model
```{r}
F1 <- log_ALC5UPYR ~ 1 + (1 | intersections) + (1 | NHISPID)

(VarCompModel <- runMLwiN(Formula = F1, data = data_intersections_MAIHDA))

# Calculate the VPC
slotNames(VarCompModel)

print(VPC <- VarCompModel["RP"][["RP2_var_Intercept"]]/(VarCompModel["RP"][["RP1_var_Intercept"]] + 
  VarCompModel["RP"][["RP2_var_Intercept"]]))
```

## Multilevel model, null

Run the null two-level model and calculate the variance partition coefficient (VPC)
```{r}
(VarCompModelMCMC <- runMLwiN(Formula = F1, 
                              data = data_intersections_MAIHDA_MCMC, 
                              estoptions = list(EstM = 1)))

slotNames(VarCompModelMCMC)

print(VPC <- VarCompModelMCMC["RP"][["RP2_var_Intercept"]]/(VarCompModelMCMC["RP"][["RP1_var_Intercept"]] + VarCompModelMCMC["RP"][["RP2_var_Intercept"]]))
```
VPC 0.1240976

## Multilevel model, main effects

Run the main-effects two-level model and recalculate VPC
```{r}
VarCompResidMCMC <- runMLwiN(Formula = F2, 
                             data = data_intersections_MAIHDA_MCMC, 
                             estoptions = list(resi.store = TRUE, EstM = 1))
# Default: burn in = 500, iterations = 5000, non-informative prior (beta 1)

slotNames(VarCompResidMCMC)

print(VPC <- VarCompResidMCMC["RP"][["RP2_var_Intercept"]]/(VarCompResidMCMC["RP"][["RP1_var_Intercept"]] + VarCompResidMCMC["RP"][["RP2_var_Intercept"]]))
```

VPC reduced to 0.01626434

# Store model results (MCMC)
```{r}
# Estimate yhat (and SEs) using predict function
data_intersections_MAIHDA_MCMC$yhat <- predict(VarCompResid) # the predicted expected value
data_intersections_MAIHDA_MCMC$yhat_se <- predict(VarCompResid, se.fit=TRUE)$se.fit # the standard error of the predicted expected value

# Create table with results for just one intersection
processed_intersections_MAIHDA_MCMC <- distinct(data_intersections_MAIHDA_MCMC, intersections, .keep_all = TRUE)

# Extract residuals from the Mlwin output object
processed_intersections_MAIHDA_MCMC$residuals <- VarCompResid@residual$lev_2_resi_est_Intercept 

# Extract the estimate of variance around the residuals, and take the sqrt of it to get the standard error around the residuals
processed_intersections_MAIHDA_MCMC$residualsSE <- sqrt(VarCompResid@residual$lev_2_resi_var_Intercept) # standard error around residuals

# Estimate the overall mean combining additive effects (main effects) and multiplicative effects (residuals)
processed_intersections_MAIHDA_MCMC <- processed_intersections_MAIHDA_MCMC %>% 
  mutate(mean = sum(yhat, residuals))

# Estimate the total standard error by combining the error around the mean plus the error around the residuals:
processed_intersections_MAIHDA_MCMC <- processed_intersections_MAIHDA_MCMC %>% 
  mutate(SE =(sqrt((yhat_se*yhat_se)+(residualsSE*residualsSE)))/2)

# Saving subset results table
Results_table_MCMC <- processed_intersections_MAIHDA_MCMC %>%
  dplyr::select(intersections, count, birth_year, YEAR, decade, AGE, SEX, race_5_cats, education_3_cats, age_3_cats, yhat, yhat_se, residuals, residualsSE, mean, SE)

Results_table_MCMC <- inner_join(Results_table_MCMC, MAIHDA_intersections_reference, by = "intersections")

saveRDS(Results_table_MCMC, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/MAIHDA_results_MCMC.RDS")
```

Saving the VarCompResidMCMC (large mlwinfitsIGLS)
```{r}
saveRDS(VarCompResidMCMC, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/VarCompResidMCMC.RDS")
```

