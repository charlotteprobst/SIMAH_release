"This script generates takes the data generated by MAIHDA and generates descriptive plots of the results"

Setup
```{r}
## Read in R packages
library(tidyverse)
library(readr)
library(tidyr)
library(dplyr)
library(labelled)
library(haven)
library(ggplot2)
library(forcats)

data_path <- "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/"
code_path <- "U:/SIMAH/SIMAH_code/nhis/intersectionality/"

## Bias toward non-scientific notation
options(scipen=10)
```

# PLOTS FROM MAIHDA BY YEARS

Load in data
```{r}
Years_2000_2004 <- read_rds(paste0(data_path,
                                   "cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2000_2004.rds"))%>%
                           mutate(year_group="2000-2004")

Years_2005_2009 <- read_rds(paste0(data_path,
                                "cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2005_2009.rds")) %>%
                                 mutate(year_group="2005-2009")

Years_2010_2014 <- read_rds(paste0(data_path,
                         "cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2010_2014.rds"))%>%
                          mutate(year_group="2010-2014")

Years_2015_2018 <- read_rds(paste0(data_path,
                              "cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2015_2018.rds"))%>%
                               mutate(year_group="2015-2018")
```

Generate columns for race, sex, education and generation (as want them named in the graph) using column intersectional names
```{r}
data_years <- rbind(Years_2000_2004, Years_2005_2009, Years_2010_2014, Years_2015_2018) %>%
  mutate(sex=ifelse(grepl("F",intersectional_names),"Female","Male"),
         race=ifelse(grepl("White",intersectional_names),"White",
              ifelse(grepl("Black", intersectional_names),"Black",
              ifelse(grepl("Hispanic", intersectional_names), "Hispanic",
              ifelse(grepl("Asian", intersectional_names), "Asian","other")))),
         education=ifelse(grepl("low edu.", intersectional_names), "low edu.",
              ifelse(grepl("med. edu.", intersectional_names), "medium edu.", "high edu.")),
         education=factor(education,levels=c("low edu.", "medium edu.", "high edu.")),
         race=factor(race, levels=c("Asian", "Black", "Hispanic", "White", "other")))
```

### Plots of residuals
separate graphs for men and women
Columns: education
Rows: race
colour: year_group
```{r}
residuals_male <- data_years %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=year_group, y=residuals, colour=year_group)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - residualsSE,
                    ymax = residuals + residualsSE),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Males: Residuals")
residuals_male

residuals_female <- data_years %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=year_group, y=residuals, colour=year_group)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - residualsSE,
                    ymax = residuals + residualsSE),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom")+
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Females: Residuals")
residuals_female
```
### Plots of predicted means and standard errors

Separate plots for men and women
Columns: education
Rows: race
colour: generation
```{r}
# Plot males
means_male <- data_years %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=year_group, y=mean, colour=year_group)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - SE,
                    ymax = mean + SE)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom") +
  ggtitle("Males: average alcohol consumption split by intersectional groups")+
  labs(y= "grams per day")
means_male

# Plot females
means_female <- data_years %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=year_group, y=mean, colour=year_group)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - SE,
                    ymax = mean + SE)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom")+
  ggtitle("Females: average alcohol consumption split by intersectional groups") +
  labs(y= "grams per day")
means_female
```






