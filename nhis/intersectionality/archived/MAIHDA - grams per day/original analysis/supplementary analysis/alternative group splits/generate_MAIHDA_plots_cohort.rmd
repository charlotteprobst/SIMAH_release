"This script generates takes the data generated by MAIHDA and generates descriptive plots of the results"

Setup
```{r}
## Read in R packages
library(tidyverse)
library(readr)
library(tidyr)
library(dplyr)
library(labelled)
library(haven)
library(ggplot2)
library(forcats)

data_path <- "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/"
code_path <- "U:/SIMAH/SIMAH_code/nhis/intersectionality/"

## Bias toward non-scientific notation
options(scipen=10)
```

Load in data
```{r}
silent <- read_rds(paste0(data_path,
                          "cleaned_data/MAIHDA results by cohort/MAIHDA_subset_results_silent.rds"))%>%
                           mutate(generation="silent")

baby_boomers <- read_rds(paste0(data_path,
                                "cleaned_data/MAIHDA results by cohort/MAIHDA_subset_results_baby_boomers.rds")) %>%
                                 mutate(generation="baby_boomers")

gen_x <- read_rds(paste0(data_path,
                         "cleaned_data/MAIHDA results by cohort/MAIHDA_subset_results_gen_x.rds"))%>%
                          mutate(generation="gen_x")

millenials <- read_rds(paste0(data_path,
                              "cleaned_data/MAIHDA results by cohort/MAIHDA_subset_results_millenials.rds"))%>%
                               mutate(generation="millenials")

gen_z <- read_rds(paste0(data_path,
                         "cleaned_data/MAIHDA results by cohort/MAIHDA_subset_results_gen_z.rds"))%>%
                          mutate(generation="gen_z")
```

Generate columns for race, sex, education and generation (as want them named in the graph) using column intersectional names
```{r}
data <- rbind(silent, baby_boomers, gen_x, millenials, gen_z) %>%
  mutate(sex=ifelse(grepl("F",intersectional_names),"Female","Male"),
         race=ifelse(grepl("White",intersectional_names),"White",
              ifelse(grepl("Black", intersectional_names),"Black",
              ifelse(grepl("Hispanic", intersectional_names), "Hispanic",
              ifelse(grepl("Asian", intersectional_names), "Asian","other")))),
         education=ifelse(grepl("low edu.", intersectional_names), "low edu.",
              ifelse(grepl("med. edu.", intersectional_names), "medium edu.", "high edu.")),
         education=factor(education,levels=c("low edu.", "medium edu.", "high edu.")),
         generation=factor(generation,levels=c("silent", "baby_boomers", "gen_x", "millenials", "gen_z")),
         race=factor(race, levels=c("Asian", "Black", "Hispanic", "White", "other")))
```

### Plots of residuals

Columns: generations
Rows: race
colour: sex
X-axis: education
```{r}
plot <- ggplot(data=data, aes(x=education, y=residuals, colour=sex)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - residualsSE,
                    ymax = residuals + residualsSE),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(generation),rows=vars(race))
plot
```
Separate plots for men and women
Columns: education
Rows: race
colour: generation
```{r}
plot_2_male <- data %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=generation, y=residuals, colour=generation)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - residualsSE,
                    ymax = residuals + residualsSE),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Males: Residuals")
plot_2_male

plot_2_female <- data %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=generation, y=residuals, colour=generation)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - residualsSE,
                    ymax = residuals + residualsSE),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom")+
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Females: Residuals")
plot_2_female
```
### Plots of predicted means and standard errors

Separate plots for men and women
Columns: education
Rows: race
colour: generation
```{r}
# Plot males
plot_2_male <- data %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=generation, y=mean, colour=generation)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - SE,
                    ymax = mean + SE)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom") +
  ggtitle("Males: average alcohol consumption split by intersectional groups")+
  labs(y= "grams per day")
plot_2_male

# Plot females
plot_2_female <- data %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=generation, y=mean, colour=generation)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean - SE,
                    ymax = mean + SE)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank (), axis.title.x = element_blank(), legend.position = "bottom")+
  ggtitle("Females: average alcohol consumption split by intersectional groups") +
  labs(y= "grams per day")
plot_2_female
```









