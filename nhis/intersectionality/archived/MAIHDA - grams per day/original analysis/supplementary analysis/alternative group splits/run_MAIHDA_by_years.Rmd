---
title: "Run MAIHDA analysis"
output: html_notebook
---

This script undertakes a multi-level analysis of individual heterogenity and discriminatory accuracy (MAIHDA)
to estimate average alcohol consumption per intersectional group of sex/age/race/SES

Setup
```{r, warning=FALSE}
# Load in data
transformed_drinkers <- readRDS("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_drinkers.RDS")

# Load necessary packages
library("R2MLwiN")
library(tidyr)
library(dplyr)

# Bias toward non-scientific notation
options(scipen=10)
```

Generate survey year groupings and add a column with a constant for runmlwin
```{r}
Years_2000_2004 <- transformed_drinkers %>% filter(YEAR >= 2000 & YEAR <= 2004) %>% mutate(cons=1)
Years_2005_2009 <- transformed_drinkers %>% filter(YEAR >= 2005 & YEAR <= 2009) %>% mutate(cons=1)
Years_2010_2014 <- transformed_drinkers %>% filter(YEAR >= 2010 & YEAR <= 2014) %>% mutate(cons=1)
Years_2015_2018 <- transformed_drinkers %>% filter(YEAR >= 2015 & YEAR <= 2018) %>% mutate(cons=1)
```

# 2000-2004

Generate null model
```{r}
Years_2000_2004_null_model <- lm(transformed_grams_lambda_1 ~ AGE + SEX + race_5_cats + education_3_cats, data = Years_2000_2004)
summary(Years_2000_2004_null_model)
```
Generate intersectional groups and create a reference table for them
```{r}
Years_2000_2004_intersections <- Years_2000_2004 %>% 
  group_by(SEX, race_5_cats, education_3_cats) %>% 
  mutate(intersections = cur_group_id()) %>%
  group_by(intersections) %>%
  mutate(count=n(),
         years="2000-2004")

temp_1 <- Years_2000_2004_intersections %>%
  mutate(sex = dplyr::recode(SEX, Male = "M", Female = "F"),
         race_5_cats = dplyr::recode(race_5_cats, 
                                     "Black/African American" = "Black", 
                                     "Hispanic, White" = "Hispanic"),
         education_3_cats = dplyr::recode(education_3_cats, 
                                          "high school or less" = "low edu.", 
                                          "some college" = "med. edu.", 
                                          "4+ years college" = "high edu."))

temp_2 <- temp_1 %>% 
  mutate(intersectional_names = as.character(paste(sex, race_5_cats, education_3_cats)))

Years_2000_2004_intersections_reference <- distinct(temp_2, intersections, .keep_all = TRUE) %>% dplyr::select(intersections, intersectional_names, count, years)
```

Multilevel model, null
```{r}
# Sort by intersections (required for Mlwin package)
Years_2000_2004_intersections <- Years_2000_2004_intersections %>% arrange(intersections)

# Run the null two-level model
F1_Years_2000_2004 <- transformed_grams_lambda_1 ~ 1 + AGE + (1 | intersections) + (1 | NHISPID)

(VarCompModel_Years_2000_2004 <- runMLwiN(Formula = F1_Years_2000_2004, data = Years_2000_2004_intersections, estoptions = list(EstM = 1)))
```
Calculate the variance partition coefficient (VPC)

```{r}
slotNames(VarCompModel_Years_2000_2004)

print(VPC <- VarCompModel_Years_2000_2004["RP"][["RP2_var_Intercept"]]/(VarCompModel_Years_2000_2004["RP"][["RP1_var_Intercept"]] + VarCompModel_Years_2000_2004["RP"][["RP2_var_Intercept"]]))

rm(VarCompModel_Years_2000_2004)
```
0.1308996 of variation at the intersectional level

Run the main-effects two-level model & recalculate VPC
```{r}
F2_Years_2000_2004 <- transformed_grams_lambda_1 ~ 1 + AGE + SEX + race_5_cats + education_3_cats + (1 | intersections) + (1 | NHISPID)

(VarCompModel2_Years_2000_2004 <- runMLwiN(Formula = F2_Years_2000_2004, data = Years_2000_2004_intersections, estoptions = list(EstM = 1)))

slotNames(VarCompModel2_Years_2000_2004)

print(VPC <- VarCompModel2_Years_2000_2004["RP"][["RP2_var_Intercept"]]/(VarCompModel2_Years_2000_2004["RP"][["RP1_var_Intercept"]] + 
  VarCompModel2_Years_2000_2004["RP"][["RP2_var_Intercept"]]))
```
0.01626286 variance remaining

## Running the model using MCMC, storing residuals
```{r}
VarCompResid_Years_2000_2004 <- runMLwiN(F2_Years_2000_2004, data = Years_2000_2004_intersections, estoptions = list(resi.store = TRUE, EstM = 1))
```
# Store model results
```{r}
# Store yhat (and SEs)
Years_2000_2004_intersections$yhat <- predict(VarCompResid_Years_2000_2004) # the predicted expected value
Years_2000_2004_intersections$yhat_se <- predict(VarCompResid_Years_2000_2004, se.fit=TRUE)$se.fit # the standard error of the predicted expected value

# Create table with results for just one intersection
distinct_processed_intersections_Years_2000_2004 <- distinct(Years_2000_2004_intersections, intersections, .keep_all = TRUE)

# Store residuals (and SEs)
distinct_processed_intersections_Years_2000_2004$residuals <- VarCompResid_Years_2000_2004@residual$lev_2_resi_est_Intercept

distinct_processed_intersections_Years_2000_2004$residualsSE <- sqrt(VarCompResid_Years_2000_2004@residual$lev_2_resi_variance_Intercept) 

distinct_processed_intersections_Years_2000_2004$residualsCI <- 1.96 * distinct_processed_intersections_Years_2000_2004$residualsSE

# Store overall mean (and SE) - combining additive and multiplicative effects
distinct_processed_intersections_Years_2000_2004$mean <- distinct_processed_intersections_Years_2000_2004$yhat + distinct_processed_intersections_Years_2000_2004$residuals

distinct_processed_intersections_Years_2000_2004$SE <- (sqrt((distinct_processed_intersections_Years_2000_2004$yhat_se*distinct_processed_intersections_Years_2000_2004$yhat_se)+(distinct_processed_intersections_Years_2000_2004$residualsSE*distinct_processed_intersections_Years_2000_2004$residualsSE)))/2

# Saving subset results table
Results_table_Years_2000_2004 <- distinct_processed_intersections_Years_2000_2004 %>%
  select(intersections, count, birth_year, YEAR, AGE, SEX, race_5_cats, education_3_cats,yhat, yhat_se, residuals, residualsSE, residualsCI, mean, SE)

Results_table_Years_2000_2004 <- inner_join(Results_table_Years_2000_2004, Years_2000_2004_intersections_reference)

saveRDS(Results_table_Years_2000_2004, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2000_2004.RDS")
```

# 2005 - 2009

Generate null model
```{r}
Years_2005_2009_null_model <- lm(transformed_grams_lambda_1 ~ AGE + SEX + race_5_cats + education_3_cats, data = Years_2005_2009)
summary(Years_2005_2009_null_model)
```
Generate intersectional groups and create a reference table for them
```{r}
Years_2005_2009_intersections <- Years_2005_2009 %>% 
  group_by(SEX, race_5_cats, education_3_cats) %>% 
  mutate(intersections = cur_group_id()) %>%
  group_by(intersections) %>%
  mutate(count=n(),
         years="2005-2009")

temp_1 <- Years_2005_2009_intersections %>%
  mutate(sex = dplyr::recode(SEX, Male = "M", Female = "F"),
         race_5_cats = dplyr::recode(race_5_cats, 
                                     "Black/African American" = "Black", 
                                     "Hispanic, White" = "Hispanic"),
         education_3_cats = dplyr::recode(education_3_cats, 
                                          "high school or less" = "low edu.", 
                                          "some college" = "med. edu.", 
                                          "4+ years college" = "high edu."))

temp_2 <- temp_1 %>% 
  mutate(intersectional_names = as.character(paste(sex, race_5_cats, education_3_cats)))

Years_2005_2009_intersections_reference <- distinct(temp_2, intersections, .keep_all = TRUE) %>% dplyr::select(intersections, intersectional_names, count, years)
```

Multilevel model, null
```{r}
# Sort by intersections (required for Mlwin package)
Years_2005_2009_intersections <- Years_2005_2009_intersections %>% arrange(intersections)

# Run the null two-level model
F1_Years_2005_2009 <- transformed_grams_lambda_1 ~ 1 + AGE + (1 | intersections) + (1 | NHISPID)

(VarCompModel_Years_2005_2009 <- runMLwiN(Formula = F1_Years_2005_2009, data = Years_2005_2009_intersections, estoptions = list(EstM = 1)))
```
Calculate the variance partition coefficient (VPC)

```{r}
slotNames(VarCompModel_Years_2005_2009)

print(VPC <- VarCompModel_Years_2005_2009["RP"][["RP2_var_Intercept"]]/(VarCompModel_Years_2005_2009["RP"][["RP1_var_Intercept"]] + VarCompModel_Years_2005_2009["RP"][["RP2_var_Intercept"]]))

rm(VarCompModel_Years_2005_2009)
```
0.1060361 of variation at the intersectional level

Run the main-effects two-level model & recalculate VPC
```{r}
F2_Years_2005_2009 <- transformed_grams_lambda_1 ~ 1 + AGE + SEX + race_5_cats + education_3_cats + (1 | intersections) + (1 | NHISPID)

(VarCompModel2_Years_2005_2009 <- runMLwiN(Formula = F2_Years_2005_2009, data = Years_2005_2009_intersections, estoptions = list(EstM = 1)))

slotNames(VarCompModel2_Years_2005_2009)

print(VPC <- VarCompModel2_Years_2005_2009["RP"][["RP2_var_Intercept"]]/(VarCompModel2_Years_2005_2009["RP"][["RP1_var_Intercept"]] + 
  VarCompModel2_Years_2005_2009["RP"][["RP2_var_Intercept"]]))
```
0.01102898 variance remaining

## Running the model using MCMC, storing residuals
```{r}
VarCompResid_Years_2005_2009 <- runMLwiN(F2_Years_2005_2009, data = Years_2005_2009_intersections, estoptions = list(resi.store = TRUE, EstM = 1))
```
# Store model results
```{r}
# Store yhat (and SEs)
Years_2005_2009_intersections$yhat <- predict(VarCompResid_Years_2005_2009) # the predicted expected value
Years_2005_2009_intersections$yhat_se <- predict(VarCompResid_Years_2005_2009, se.fit=TRUE)$se.fit # the standard error of the predicted expected value

# Create table with results for just one intersection
distinct_processed_intersections_Years_2005_2009 <- distinct(Years_2005_2009_intersections, intersections, .keep_all = TRUE)

# Store residuals (and SEs)
distinct_processed_intersections_Years_2005_2009$residuals <- VarCompResid_Years_2005_2009@residual$lev_2_resi_est_Intercept

distinct_processed_intersections_Years_2005_2009$residualsSE <- sqrt(VarCompResid_Years_2005_2009@residual$lev_2_resi_variance_Intercept) 

distinct_processed_intersections_Years_2005_2009$residualsCI <- 1.96 * distinct_processed_intersections_Years_2005_2009$residualsSE

# Store overall mean (and SE) - combining additive and multiplicative effects
distinct_processed_intersections_Years_2005_2009$mean <- distinct_processed_intersections_Years_2005_2009$yhat + distinct_processed_intersections_Years_2005_2009$residuals

distinct_processed_intersections_Years_2005_2009$SE <- (sqrt((distinct_processed_intersections_Years_2005_2009$yhat_se*distinct_processed_intersections_Years_2005_2009$yhat_se)+(distinct_processed_intersections_Years_2005_2009$residualsSE*distinct_processed_intersections_Years_2005_2009$residualsSE)))/2

# Saving subset results table
Results_table_Years_2005_2009 <- distinct_processed_intersections_Years_2005_2009 %>%
  select(intersections, count, birth_year, YEAR, AGE, SEX, race_5_cats, education_3_cats, yhat, yhat_se, residuals, residualsSE, residualsCI, mean, SE)

Results_table_Years_2005_2009 <- inner_join(Results_table_Years_2005_2009, Years_2005_2009_intersections_reference)

saveRDS(Results_table_Years_2005_2009, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2005_2009.RDS")
```
# 2010-2014

Generate null model
```{r}
Years_2010_2014_null_model <- lm(transformed_grams_lambda_1 ~ AGE + SEX + race_5_cats + education_3_cats, data = Years_2010_2014)
summary(Years_2010_2014_null_model)
```
Generate intersectional groups and create a reference table for them
```{r}
Years_2010_2014_intersections <- Years_2010_2014 %>% 
  group_by(SEX, race_5_cats, education_3_cats) %>% 
  mutate(intersections = cur_group_id()) %>%
  group_by(intersections) %>%
  mutate(count=n(),
         years="2010-2014")

temp_1 <- Years_2010_2014_intersections %>%
  mutate(sex = dplyr::recode(SEX, Male = "M", Female = "F"),
         race_5_cats = dplyr::recode(race_5_cats, 
                                     "Black/African American" = "Black", 
                                     "Hispanic, White" = "Hispanic"),
         education_3_cats = dplyr::recode(education_3_cats, 
                                          "high school or less" = "low edu.", 
                                          "some college" = "med. edu.", 
                                          "4+ years college" = "high edu."))

temp_2 <- temp_1 %>% 
  mutate(intersectional_names = as.character(paste(sex, race_5_cats, education_3_cats)))

Years_2010_2014_intersections_reference <- distinct(temp_2, intersections, .keep_all = TRUE) %>% dplyr::select(intersections, intersectional_names, count, years)
```

Multilevel model, null
```{r}
# Sort by intersections (required for Mlwin package)
Years_2010_2014_intersections <- Years_2010_2014_intersections %>% arrange(intersections)

# Run the null two-level model
F1_Years_2010_2014 <- transformed_grams_lambda_1 ~ 1 + AGE + (1 | intersections) + (1 | NHISPID)

(VarCompModel_Years_2010_2014 <- runMLwiN(Formula = F1_Years_2010_2014, data = Years_2010_2014_intersections, estoptions = list(EstM = 1)))
```
Calculate the variance partition coefficient (VPC)

```{r}
slotNames(VarCompModel_Years_2010_2014)

print(VPC <- VarCompModel_Years_2010_2014["RP"][["RP2_var_Intercept"]]/(VarCompModel_Years_2010_2014["RP"][["RP1_var_Intercept"]] + VarCompModel_Years_2010_2014["RP"][["RP2_var_Intercept"]]))

rm(VarCompModel_Years_2010_2014)
```
0.09557531 of variation at the intersectional level

Run the main-effects two-level model & recalculate VPC
```{r}
F2_Years_2010_2014 <- transformed_grams_lambda_1 ~ 1 + AGE + SEX + race_5_cats + education_3_cats + (1 | intersections) + (1 | NHISPID)

(VarCompModel2_Years_2010_2014 <- runMLwiN(Formula = F2_Years_2010_2014, data = Years_2010_2014_intersections, estoptions = list(EstM = 1)))

slotNames(VarCompModel2_Years_2010_2014)

print(VPC <- VarCompModel2_Years_2010_2014["RP"][["RP2_var_Intercept"]]/(VarCompModel2_Years_2010_2014["RP"][["RP1_var_Intercept"]] + 
  VarCompModel2_Years_2010_2014["RP"][["RP2_var_Intercept"]]))
```
0.01015662 variance remaining

## Running the model using MCMC, storing residuals
```{r}
VarCompResid_Years_2010_2014 <- runMLwiN(F2_Years_2010_2014, data = Years_2010_2014_intersections, estoptions = list(resi.store = TRUE, EstM = 1))
```
# Store model results
```{r}
# Store yhat (and SEs)
Years_2010_2014_intersections$yhat <- predict(VarCompResid_Years_2010_2014) # the predicted expected value
Years_2010_2014_intersections$yhat_se <- predict(VarCompResid_Years_2010_2014, se.fit=TRUE)$se.fit # the standard error of the predicted expected value

# Create table with results for just one intersection
distinct_processed_intersections_Years_2010_2014 <- distinct(Years_2010_2014_intersections, intersections, .keep_all = TRUE)

# Store residuals (and SEs)
distinct_processed_intersections_Years_2010_2014$residuals <- VarCompResid_Years_2010_2014@residual$lev_2_resi_est_Intercept

distinct_processed_intersections_Years_2010_2014$residualsSE <- sqrt(VarCompResid_Years_2010_2014@residual$lev_2_resi_variance_Intercept) 

distinct_processed_intersections_Years_2010_2014$residualsCI <- 1.96 * distinct_processed_intersections_Years_2010_2014$residualsSE

# Store overall mean (and SE) - combining additive and multiplicative effects
distinct_processed_intersections_Years_2010_2014$mean <- distinct_processed_intersections_Years_2010_2014$yhat + distinct_processed_intersections_Years_2010_2014$residuals

distinct_processed_intersections_Years_2010_2014$SE <- (sqrt((distinct_processed_intersections_Years_2010_2014$yhat_se*distinct_processed_intersections_Years_2010_2014$yhat_se)+(distinct_processed_intersections_Years_2010_2014$residualsSE*distinct_processed_intersections_Years_2010_2014$residualsSE)))/2

# Saving subset results table
Results_table_Years_2010_2014 <- distinct_processed_intersections_Years_2010_2014 %>%
  select(intersections, count, birth_year, YEAR, AGE, SEX, race_5_cats, education_3_cats, yhat, yhat_se, residuals, residualsSE, residualsCI, mean, SE)

Results_table_Years_2010_2014 <- inner_join(Results_table_Years_2010_2014, Years_2010_2014_intersections_reference)

saveRDS(Results_table_Years_2010_2014, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2010_2014.RDS")
```

# 2015-2018


Generate null model
```{r}
Years_2015_2018_null_model <- lm(transformed_grams_lambda_1 ~ AGE + SEX + race_5_cats + education_3_cats, data = Years_2015_2018)
summary(Years_2015_2018_null_model)
```
Generate intersectional groups and create a reference table for them
```{r}
Years_2015_2018_intersections <- Years_2015_2018 %>% 
  group_by(SEX, race_5_cats, education_3_cats) %>% 
  mutate(intersections = cur_group_id()) %>%
  group_by(intersections) %>%
  mutate(count=n(),
         years="2015-2018")

temp_1 <- Years_2015_2018_intersections %>%
  mutate(sex = dplyr::recode(SEX, Male = "M", Female = "F"),
         race_5_cats = dplyr::recode(race_5_cats, 
                                     "Black/African American" = "Black", 
                                     "Hispanic, White" = "Hispanic"),
         education_3_cats = dplyr::recode(education_3_cats, 
                                          "high school or less" = "low edu.", 
                                          "some college" = "med. edu.", 
                                          "4+ years college" = "high edu."))

temp_2 <- temp_1 %>% 
  mutate(intersectional_names = as.character(paste(sex, race_5_cats, education_3_cats)))

Years_2015_2018_intersections_reference <- distinct(temp_2, intersections, .keep_all = TRUE) %>% dplyr::select(intersections, intersectional_names, count, years)
```

Multilevel model, null
```{r}
# Sort by intersections (required for Mlwin package)
Years_2015_2018_intersections <- Years_2015_2018_intersections %>% arrange(intersections)

# Run the null two-level model
F1_Years_2015_2018 <- transformed_grams_lambda_1 ~ 1 + AGE + (1 | intersections) + (1 | NHISPID)

(VarCompModel_Years_2015_2018 <- runMLwiN(Formula = F1_Years_2015_2018, data = Years_2015_2018_intersections, estoptions = list(EstM = 1)))
```
Calculate the variance partition coefficient (VPC)

```{r}
slotNames(VarCompModel_Years_2015_2018)

print(VPC <- VarCompModel_Years_2015_2018["RP"][["RP2_var_Intercept"]]/(VarCompModel_Years_2015_2018["RP"][["RP1_var_Intercept"]] + VarCompModel_Years_2015_2018["RP"][["RP2_var_Intercept"]]))

rm(VarCompModel_Years_2015_2018)
```
0.09088508 of variation at the intersectional level

Run the main-effects two-level model & recalculate VPC
```{r}
F2_Years_2015_2018 <- transformed_grams_lambda_1 ~ 1 + AGE + SEX + race_5_cats + education_3_cats + (1 | intersections) + (1 | NHISPID)

(VarCompModel2_Years_2015_2018 <- runMLwiN(Formula = F2_Years_2015_2018, data = Years_2015_2018_intersections, estoptions = list(EstM = 1)))

slotNames(VarCompModel2_Years_2015_2018)

print(VPC <- VarCompModel2_Years_2015_2018["RP"][["RP2_var_Intercept"]]/(VarCompModel2_Years_2015_2018["RP"][["RP1_var_Intercept"]] +   VarCompModel2_Years_2015_2018["RP"][["RP2_var_Intercept"]]))
```
0.01074902 variance remaining

## Running the model using MCMC, storing residuals
```{r}
VarCompResid_Years_2015_2018 <- runMLwiN(F2_Years_2015_2018, data = Years_2015_2018_intersections, estoptions = list(resi.store = TRUE, EstM = 1))
```
# Store model results
```{r}
# Store yhat (and SEs)
Years_2015_2018_intersections$yhat <- predict(VarCompResid_Years_2015_2018) # the predicted expected value
Years_2015_2018_intersections$yhat_se <- predict(VarCompResid_Years_2015_2018, se.fit=TRUE)$se.fit # the standard error of the predicted expected value

# Create table with results for just one intersection
distinct_processed_intersections_Years_2015_2018 <- distinct(Years_2015_2018_intersections, intersections, .keep_all = TRUE)

# Store residuals (and SEs)
distinct_processed_intersections_Years_2015_2018$residuals <- VarCompResid_Years_2015_2018@residual$lev_2_resi_est_Intercept

distinct_processed_intersections_Years_2015_2018$residualsSE <- sqrt(VarCompResid_Years_2015_2018@residual$lev_2_resi_variance_Intercept) 

distinct_processed_intersections_Years_2015_2018$residualsCI <- 1.96 * distinct_processed_intersections_Years_2015_2018$residualsSE

# Store overall mean (and SE) - combining additive and multiplicative effects
distinct_processed_intersections_Years_2015_2018$mean <- distinct_processed_intersections_Years_2015_2018$yhat + distinct_processed_intersections_Years_2015_2018$residuals

distinct_processed_intersections_Years_2015_2018$SE <- (sqrt((distinct_processed_intersections_Years_2015_2018$yhat_se*distinct_processed_intersections_Years_2015_2018$yhat_se)+(distinct_processed_intersections_Years_2015_2018$residualsSE*distinct_processed_intersections_Years_2015_2018$residualsSE)))/2

# Saving subset results table
Results_table_Years_2015_2018 <- distinct_processed_intersections_Years_2015_2018 %>%
  select(intersections, count, birth_year, YEAR, AGE, SEX, race_5_cats, education_3_cats, yhat, yhat_se, residuals, residualsSE, residualsCI, mean, SE)

Results_table_Years_2015_2018 <- inner_join(Results_table_Years_2015_2018, Years_2015_2018_intersections_reference)

saveRDS(Results_table_Years_2015_2018, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/MAIHDA results by year/MAIHDA_subset_results_Years_2015_2018.RDS")
```
# Generate combined reference table capturing intersections used across each year grouping
```{r}
reference_table <- rbind(Years_2000_2004_intersections_reference, Years_2005_2009_intersections_reference, Years_2010_2014_intersections_reference, Years_2015_2018_intersections_reference)
```

