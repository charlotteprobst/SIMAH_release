"This script generates takes the data generated by MAIHDA and generates descriptive plots of the results"

Setup
```{r}
## Read in R packages
library(tidyverse)
library(readr)
library(tidyr)
library(dplyr)
library(labelled)
library(haven)
library(ggplot2)
library(forcats)

## Bias toward non-scientific notation
options(scipen=10)

# Set default theme for plots:
theme_set(theme_bw(base_size = 12))
```

Load in data
```{r}
plot_data <- read_rds("U:\\SIMAH\\SIMAH_workplace\\nhis\\intersectionality\\cleaned_data\\HED\\Results_table_HED_probability.RDS")
```

Generate columns as want them named & ordered in the graph
```{r}
plot_data <- plot_data %>% mutate(
  race = case_when(
    race_5_cats == "Non-Hispanic Asian" ~ "Asian",
    race_5_cats == "Non-Hispanic Black/African American" ~ "Black",
    race_5_cats == "Non-Hispanic Other" ~ "Other",
    race_5_cats == "Non-Hispanic White" ~ "White",
    race_5_cats == "Hispanic" ~ "Hispanic"),
  education = case_when(
    education_3_cats == "high school or less" ~ "low edu.",
    education_3_cats == "some college" ~ "medium edu.",
    education_3_cats == "4+ years college" ~ "high edu."),
  education=factor(education,levels=c("low edu.", "medium edu.", "high edu.")))
```

### Plots of residuals
Separate plots for men and women
```{r}
male_residuals_HED <- plot_data %>%
  filter(SEX=="Male") %>%
  ggplot(aes(x=age_3_cats, y=residuals, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - (1.96*residuals_se),
                    ymax = residuals + (1.96*residuals_se)),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Males: Residuals")
male_residuals_HED

female_residuals_HED <- plot_data %>%
  filter(SEX=="Female") %>%
  ggplot(aes(x=age_3_cats, y=residuals, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - (1.96*residuals_se),
                    ymax = residuals + (1.96*residuals_se)),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Females: Residuals")
female_residuals_HED
```
# Count number of intersections with CIs that don't include 0
```{r}
plot_data %>% 
  mutate(
    ymin = residuals - (1.96*residuals_se),
    ymax = residuals + (1.96*residuals_se),
    sig_resid = case_when(ymin > 0 & ymax > 0 ~ "more",
                          ymin < 0 & ymax < 0 ~ "less",
                          ymin < 0 & ymax > 0 ~ "expected")
  ) %>%
  filter(sig_resid!="expected") %>%
  select(intersections, SEX, decade, race, age_3_cats, education, ymin, ymax, sig_resid) %>%
  nrow()
```
### Plots of predicted probabilities and standard errors 

Separate plots for men and women
```{r}
# Plot males
male_HED_probability <- plot_data %>%
  filter(SEX=="Male") %>%
  ggplot(aes(x=age_3_cats, y=probability, colour=decade)) +
  geom_point(position=position_dodge(width=1)) +
  geom_errorbar(aes(ymin = CI_lower,
                    ymax = CI_upper),
                    position=position_dodge(width=1)) +
  ylim(0, 1) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ggtitle("Males: probability of HED by intersectional groups")+
  labs(y= "Probability")
male_HED_probability

# Plot females
female_HED_probability <- plot_data %>%
  filter(SEX=="Female") %>%
  ggplot(aes(x=age_3_cats, y=probability, colour=decade)) +
  geom_point(position=position_dodge(width=1)) +
  geom_errorbar(aes(ymin = CI_lower,
                    ymax = CI_upper),
                    position=position_dodge(width=1)) +
  ylim(0, 1) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ggtitle("Females: probability of HED by intersectional groups")+
  labs(y= "Probability")
female_HED_probability
```
