---
title: "1_process_raw_nhis"
---

"This script cleans the raw nhis data for interesectional analysis, specifically it:
- sub-sets nhis data (2000-2018; only adults aged >18yrs; only sample adults; only variables of interest)
- reviews missing data patterns
- removes people missing essential variables (education, alcohol status, alcohol details for drinkers)
- creates categorical variables for SES, race and age (and label them)
- estimates individuals daily grams of alcohol intake based on alcohol question responses
- assigns categorical drinking status based on grams per day
- transforms grams per day to fit normal distribution (for drinkers only)
- saves cleaned data files as RDS and CSV files, ready for analysis"

# Setup
```{r, warning = FALSE}
# Set wd
setwd("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_code/nhis/intersectionality")

# Read in necessary R packages
library(tidyverse)
library(readr)
library(tidyr)
library(dplyr)
library(ipumsr)     # load in data extracted from IPUMS website
library(labelled)
library(haven)
library(mice)
library(clipr)
library(forecast)
library(MASS)

# Clear environment
rm(list = ls())

# Source required functions
source("functions/recode_to_NA_all.R")
source("functions/remove_na.R")
source("functions/generate_ALCSTAT.R")
source("functions/assign_grams_alcohol.R")
source("functions/recode_alc_cats.R")
source("functions/recode_race_ethnicity.R")
source("functions/recode_income.R")
source("functions/recode_education.R")
source("functions/recode_age.R")
source("functions/recode_sexorien.R")
source("functions/recode_cohort.R")

# Set default theme for plots:
theme_set(theme_bw(base_size = 12))

# Bias towards non scientific notation
options(scipen = 100)

# Read in data extracted from IPUMS:
# ddi <- read_ipums_ddi("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/raw_data/nhis_00005.xml")
# data <- read_ipums_micro(ddi)

# Save extracted data as .RDS file
# saveRDS(data, "C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/1_nhis_full_extract.RDS")
 
# Read in extracted data:
# nhis_full_extract <- readRDS("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/1_nhis_full_extract.RDS")
```
NB. Extracted NHIS data obtained from nhis.ipums.org (Lynn A. Blewett, Julia A. Rivera Drew, Miriam L. King, Kari C.W. Williams, Natalie Del Ponte and Pat Convey. IPUMS Health Surveys: National Health Interview Survey, Version 7.1 [dataset]. Minneapolis, MN: IPUMS, 2021).
Available at: https://doi.org/10.18128/D070.V7.1
Years requested: 2000-2020

# Subset relevant data fields and individuals
```{r}
# # Select relevant years and individuals aged > 18
# nhis_subset <- nhis_full_extract %>%
#      dplyr::select(YEAR, INTERVWMO, INTERVWYR, NHISPID, PERWEIGHT, SAMPWEIGHT, AGE, BIRTHYR, SEX, SEXORIEN, EDUCREC2, RACENEW, HISPYN, USBORN, CITIZEN, INCFAM97ON2, starts_with("ALC"), starts_with("MORT"), SMOKFREQNOW) %>%
# # exclude <18 as not asked about alcohol:
# filter(AGE >=18) %>%
# # exclude years 2019 and 2020 as missing critical info (No alc Qs in 2019; No ALC5UPYR in 2020; No EDUC & Income in 2019/20)
# filter(YEAR <=2018)
# # n= 1,298,461
# 
# # Exclude individuals not in the adult sample (i.e. those with alc questions Not In Universe)
# nhis_subset <- nhis_subset %>%
#    filter(ALCSTAT1 != 0)
# 
# # Create data dictionary for reference
# dictionary <- labelled::generate_dictionary(nhis_subset)
# 
# # Zap labels from the dataframe to facilitate data manipulation 
# nhis_subset <- nhis_subset %>% zap_formats() %>% zap_labels()
# 
# # Save the subset data
# saveRDS(nhis_subset, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/2_nhis_subset.RDS")

# Read in the subset data
nhis_subset <- readRDS("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/2_nhis_subset.RDS")
```

# Recategorise demographic variables
```{r}
# Convert all types of NA to be consistent i.e. convert 'refused', 'not ascertained', 'don't know', 'inconsistent' and 'NIU' to NA
nhis_subset_converted_NA <- recode_to_NA_all(nhis_subset)

# Create new categories for age, race, sexual orientation, income, education and birth cohort

# AGE
# Recategorise age into 3 categories:
nhis_subset_age <- recode_age(nhis_subset_converted_NA)

## Label new age categories:
nhis_subset_age$age_3_cats <- factor(nhis_subset_age$age_3_cats,
                                                 levels = c(1,2,3),
                                                 labels = c("18-24", "25-69", "70+"))

nhis_subset_age$age_3_cats_uneven_splits <- factor(nhis_subset_age$age_3_cats_uneven_splits,
                                                 levels = c(1,2,3),
                                                 labels = c("18-20", "21-69", "70+"))

nhis_subset_age$age_4_cats <- factor(nhis_subset_age$age_4_cats,
                                                 levels = c(1,2,3,4),
                                                 labels = c("18-20", "21-23", "24-69", "70+"))

# RACE/ETHNICITY

# Recategorise to combine race and hispanic ethnicity
nhis_subset_race <- recode_race_ethnicity(nhis_subset_age) 

# Label new race categories:
nhis_subset_race$race_5_cats <- factor(nhis_subset_race$race_5_cats,
                    levels = c(1,2,3,4,5),
                    labels = c("Non-Hispanic White", "Non-Hispanic Black/African American", "Non-Hispanic Asian", "Non-Hispanic Other", "Hispanic"))

# SEXORIEN
# Recategorise sexual orientation into 2 categories (converts I don't know the answer to NA):
nhis_subset_sexorien <- recode_sexorien(nhis_subset_race)

# Label sexual orientation categories:
nhis_subset_sexorien$SEXORIEN <- factor(nhis_subset_sexorien$SEXORIEN,
                              levels = c(1,2),
                              labels = c("Heterosexual", "Homosexual/bisexual/something else"))

# INCOME
nhis_subset_income <- recode_income(nhis_subset_sexorien)

# Label new income categories:
nhis_subset_income$income <- factor(nhis_subset_income$income,
                    levels = c(1,2,3,4),
                    labels = c("$0 - $34,999", "$35,000-$74,999", "$75,000-$99,999","$100,000 and over"))

# SES (EDUCATION)
nhis_subset_education <- recode_education(nhis_subset_income)

# Label new education categories:
nhis_subset_education$education_3_cats <- factor(nhis_subset_education$education_3_cats,
                                    levels = c(1,2,3),
                                    labels = c("high school or less", "some college", "4+ years college"))

nhis_subset_education$education_4_cats <- factor(nhis_subset_education$education_4_cats,
                                    levels = c(1,2,3,4),
                                    labels = c("no high school (<= grade 8)", "some high school or high school graduate", "some college", "4+ years college"))

nhis_subset_education$education_5_cats <- factor(nhis_subset_education$education_5_cats,
                                    levels = c(1,2,3,4,5),
                                    labels = c("no high school (<= grade 8)", "Some high school (grades 9-11)", "Finished high school (grade 12)", "Some college", "4+ years college"))

# BIRTH COHORT:

# Rename birth year column
nhis_subset_cohort <- rename(nhis_subset_education, birth_year = BIRTHYR)

# Check number missing birth year:
sum(is.na(nhis_subset_cohort$birth_year)) # 77,046 individuals missing birth year, therefore generate a birth year estimate for those missing birth year

# Generate birth year estimate manually
nhis_subset_cohort <- nhis_subset_cohort %>% 
  mutate(birth_year_est = ifelse(is.na(birth_year), YEAR-AGE, birth_year))
  
# Group into cohorts based on estimated year of birth
nhis_subset_cohort <- recode_cohort(nhis_subset_cohort)

# Label new cohort categories:
nhis_subset_cohort$birth_cohort <- factor(nhis_subset_cohort$birth_cohort,
                                    levels = c(1,2,3,4,5),
                                    labels = c("silent", "baby_boomers", "gen_x", "millenials", "gen_z"))

# YEAR

# Add grouped_year (~ by decades) as a new variable
nhis_subset_decade <- nhis_subset_cohort %>% mutate(
      decade = case_when(
      YEAR == 2000 | YEAR == 2001 | YEAR == 2002 | YEAR == 2003 | YEAR == 2004 |
      YEAR == 2005 | YEAR == 2006 | YEAR == 2007 | YEAR == 2008 | YEAR == 2009 ~ 1, 
      YEAR == 2010 | YEAR == 2011 | YEAR == 2012 | YEAR == 2013 | YEAR == 2014 | 
      YEAR == 2015 | YEAR == 2016 | YEAR == 2017 | YEAR == 2018  ~ 2))

# Label new categories:
nhis_subset_decade$decade <- factor(nhis_subset_decade$decade,
                                          levels = c(1,2),
                                          labels = c("2000-2009","2010-2018"))
# FINAL RECODED DATASET:
nhis_subset_recoded <- nhis_subset_decade
```

# Review demographics of the sample adult subset (so can compare to overall population demographics)
Male =1 Female = 2
```{r}
# by sex and race only:
sample_adults_by_sex_race <- nhis_subset_recoded %>% 
  count(SEX, race_5_cats) %>%
  mutate(percent = n/sum(n)*100) %>%
  group_by(SEX) %>%
  arrange(desc(percent), .by_group = TRUE)

# by sex, race and age group:
sample_adults_by_sex_race_age <- nhis_subset_recoded %>% 
  count(SEX, age_3_cats, race_5_cats) %>%
  mutate(percent = n/sum(n)*100) %>%
  group_by(SEX) %>%
  arrange(desc(percent), .by_group = TRUE)

saveRDS(sample_adults_by_sex_race_age, "C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/sample_adults_demographics.RDS")
```

# Review missing data
NB. There is no missing age, race or hisp-ethnicity data, so these variables are not shown.
A large proportion of sexual orientation data and of income data is missing and so this may need to be imputed (if appropriate), if it were to be included in the analysis.

```{r,  warning = FALSE}
# BY SEX
nhis_subset_recoded %>% 
  group_by(SEX) %>%
  mutate(n=1) %>%
  summarise(total_pop = sum(n), 
            Age_NA = sum(is.na(AGE)), 
            Educ_NA = sum(is.na(EDUCREC2)),
            Sex_orien_NA = sum(is.na(SEXORIEN)),
            Income_NA = sum(is.na(income)),
            Alc_status_NA = sum(is.na(ALCSTAT1)),
            birth_year_NA = sum(is.na(birth_year)),
            # Calculate percentages for variables with some missing data:
            perc_missing_Alc_status = (Alc_status_NA/total_pop)*100,
            perc_missing_edu = (Educ_NA/total_pop)*100,
            perc_missing_income = (Income_NA/total_pop)*100,
            perc_missing_sex_orien = (Sex_orien_NA/total_pop)*100,
            perc_missing_birth_year = (birth_year_NA/total_pop)*100) %>%
  arrange(perc_missing_Alc_status)

# BY AGE
nhis_subset_recoded %>% 
  group_by(age_4_cats) %>%
  mutate(n=1) %>%
  summarise(total_pop = sum(n), 
            Age_NA = sum(is.na(AGE)), 
            Educ_NA = sum(is.na(EDUCREC2)),
            Sex_orien_NA = sum(is.na(SEXORIEN)),
            Income_NA = sum(is.na(income)),
            Alc_status_NA = sum(is.na(ALCSTAT1)),
            # Calculate percentages for variables with some missing data:
            perc_missing_edu = (Educ_NA/total_pop)*100, 
            perc_missing_sex_orien = (Sex_orien_NA/total_pop)*100,
            perc_missing_income = (Income_NA/total_pop)*100,
            perc_missing_Alc_status = (Alc_status_NA/total_pop)*100) %>%
  arrange(perc_missing_Alc_status)

# BY RACE
nhis_subset_recoded %>% 
  group_by(race_5_cats) %>%
  mutate(n=1) %>%
  summarise(total_pop = sum(n), 
            Age_NA = sum(is.na(AGE)), 
            Educ_NA = sum(is.na(EDUCREC2)),
            Sex_orien_NA = sum(is.na(SEXORIEN)),
            Income_NA = sum(is.na(income)),
            Alc_status_NA = sum(is.na(ALCSTAT1)),
            # Calculate percentages for variables with some missing data:
            perc_missing_edu = (Educ_NA/total_pop)*100, 
            perc_missing_sex_orien = (Sex_orien_NA/total_pop)*100,
            perc_missing_income = (Income_NA/total_pop)*100,
            perc_missing_Alc_status = (Alc_status_NA/total_pop)*100) %>%
  arrange(perc_missing_Alc_status)

# BY SES
nhis_subset_recoded %>% 
  group_by(education_5_cats) %>%
  mutate(n=1) %>%
  summarise(total_pop = sum(n), 
            Age_NA = sum(is.na(AGE)), 
            Educ_NA = sum(is.na(EDUCREC2)),
            Sex_orien_NA = sum(is.na(SEXORIEN)),
            Income_NA = sum(is.na(income)),
            Alc_status_NA = sum(is.na(ALCSTAT1)),
            # Calculate percentages for variables with some missing data:
            perc_missing_edu = (Educ_NA/total_pop)*100, 
            perc_missing_sex_orien = (Sex_orien_NA/total_pop)*100,
            perc_missing_income = (Income_NA/total_pop)*100,
            perc_missing_Alc_status = (Alc_status_NA/total_pop)*100) %>%
  arrange(perc_missing_Alc_status)

# BY YEAR
missing_data_year <- nhis_subset_recoded %>% 
  group_by(YEAR) %>%
  mutate(n=1) %>%
  summarise(total_pop = sum(n), 
            Age_NA = sum(is.na(AGE)), 
            Educ_NA = sum(is.na(EDUCREC2)),
            Sex_orien_NA = sum(is.na(SEXORIEN)),
            Income_NA = sum(is.na(income)),
            Alc_status_NA = sum(is.na(ALCSTAT1)),
            # Calculate percentages for variables with some missing data:
            perc_missing_edu = (Educ_NA/total_pop)*100, 
            perc_missing_sex_orien = (Sex_orien_NA/total_pop)*100,
            perc_missing_income = (Income_NA/total_pop)*100,
            perc_missing_Alc_status = (Alc_status_NA/total_pop)*100) %>%
  arrange(YEAR)
```
As shown, Alc status and education are not missing > 3% in any year
Sexual orientation has a large proportion of missing data as this was not captured pre-2013.
Income data was missing more pre-2006.

## Missing data by intersectional group
Some groups (small n) missing alc data entirely.
Income is missing more than education.

# KEEP THINKING ABOUT THIS! ANALYSIS ON DRINKERS ONLY - CURRENT LOOKING AT MISSING DATA IS FOR ALL.
# MISMATCH BETWEEN WHAT THIS SAYS AND WHAT INTERSECTIONAL GROUP SIZES SAYS

```{r,  warning = FALSE}
## Review missing data for full sample by combinations of key demographics:
view <- nhis_subset_recoded %>% 
  group_by(SEX, age_3_cats, race_5_cats, education_3_cats, decade) %>%
  mutate(n=1,
         total_pop = sum(n), 
            Age_NA = sum(is.na(AGE)), 
            Educ_NA = sum(is.na(EDUCREC2)),
            Sex_orien_NA = sum(is.na(SEXORIEN)),
            Income_NA = sum(is.na(income)),
            Alc_status_NA = sum(is.na(ALCSTAT1)),
            # Calculate percentages for variables with some missing data:
            perc_missing_age = (Age_NA/total_pop)*100, 
            perc_missing_edu = (Educ_NA/total_pop)*100, 
            perc_missing_sex_orien = (Sex_orien_NA/total_pop)*100,
            perc_missing_income = (Income_NA/total_pop)*100,
            perc_missing_Alc_status = (Alc_status_NA/total_pop)*100) %>%
            arrange(desc(perc_missing_Alc_status))
  
```

## Missing data by alcohol variable (drinkers only))
This table shows the percentage of missing alcohol consumption patterns data for drinkers.
As shown, <3% of specific alcohol consumption variables are missing (across age, gender and race).
Higher amounts of missing alcohol consumption data are present for those with missing education data.

```{r}
## Review missing consumption patterns data for drinkers:
nhis_subset_recoded %>% 
  filter(ALCSTAT1==3) %>% 
  group_by(SEX, age_3_cats, race_5_cats, education_3_cats) %>%
  mutate(n=1) %>%
  summarise(total_pop = sum(n), 
            ALC_AMT_NA = sum(is.na(ALCAMT)),
            ALC_over5_NA = sum(is.na(ALC5UPYR)),
            ALC_DAYS_NA = sum(is.na(ALCDAYSYR)),
            perc_missing_ALC_amt = (ALC_AMT_NA/total_pop)*100,
            perc_missing_ALC_over5 = (ALC_over5_NA/total_pop)*100,
            perc_missing_ALC_days_yr = (ALC_DAYS_NA/total_pop)*100) %>%
    arrange(perc_missing_ALC_amt)
```

## Exploring missing data via MICE package

There is an apparent correlation between the amount of missing education data and alcstat data
```{r}
nhis_subset_recoded %>%
  dplyr::select(ALCSTAT1, age_3_cats, race_5_cats, SEX, education_3_cats, income) %>%
  md.pattern()
```

Below is a correlation matrix to explore which two variables tend to have missing values together.
As shown, there is a very weak relationship between missing education level data and missing alcohol status data (0.148)
```{r}
# Create a shadow matrix in which missing values are replaced by “1”, and nonmissing values are replaced by “0”:

shadow_variables <- nhis_subset_recoded %>% dplyr::select(age_3_cats, race_5_cats, SEX, education_3_cats, income, ALCSTAT1)
shadow <- as.data.frame(abs(is.na(shadow_variables)))

# Create a new data frame in which only variables with one or more missing values are retained.
missing_shadow <- shadow[,which(unlist(lapply(shadow,sum))!=0)]
round(cor(missing_shadow),3)
```

## Drop individuals missing essential demographic data

Remove individuals missing essential demographic data:
```{r}
edu_variables <- c("education_3_cats", "education_4_cats", "education_5_cats")
nhis_subset_dropped_demo_na <- remove_na(nhis_subset_recoded, all_of(edu_variables))
```
Remove individuals missing drinking status (drinking status 'NA'):
```{r}
nhis_subset_dropped_alcstat_na <- remove_na(nhis_subset_dropped_demo_na, "ALCSTAT1")
```
Remove individuals missing essential alcohol consumption data:
```{r}
# Drop individuals who drink, but who are missing information on consumption patterns...

## Temporarily subset drinkers and non-drinkers:
drinkers <- subset(nhis_subset_dropped_alcstat_na, ALCSTAT1==3)
non_drinkers <- subset(nhis_subset_dropped_alcstat_na, ALCSTAT1==1| ALCSTAT1==2)

variables <- c("ALCAMT","ALC5UPYR","ALCDAYSYR")
drinkers_dropped_na <- remove_na(drinkers, variables)

## Rejoin drinkers (those with adequate data) and non-drinkers together
nhis_subset_dropped_alc_na <- rbind(drinkers_dropped_na, non_drinkers)
```

# Process alcohol data (estimate grams_per_day)
```{r}
## Estimate average grams of alcohol use per person and assign as a new variable ("alc_daily_g")
##(Expanded Quantity/Frequency (QF) Approach & assuming standard drink size)
nhis_subset_grams_alc <- assign_grams_alcohol(nhis_subset_dropped_alc_na)

## Create more detailed sub-categories of alcohol use based on average alcohol consumption (grams):
nhis_subset_alc_cats <- recode_alc_cats(nhis_subset_grams_alc)

## Label new categories:
nhis_subset_alc_cats$alc_4_cats <- factor(nhis_subset_alc_cats$alc_4_cats,
                                          levels = c(1,2,3,4),
                                          labels = c("Abstainers (lifetime abstainers & former drinkers)", 
                                                     "Category I", "Category II", "Category III"))

nhis_subset_alc_cats$alc_5_cats <- factor(nhis_subset_alc_cats$alc_5_cats,
                                          levels = c(1,2,3,4,5),
                                          labels = c("lifetime abstainers","former drinkers",
                                                     "Category I", "Category II", "Category III"))

nhis_subset_alc_cats$alc_6_cats <- factor(nhis_subset_alc_cats$alc_6_cats,
                                          levels = c(1,2,3,4,5,6),
                                          labels = c("lifetime abstainers","former drinkers",
                                                     "Category I", "Category II", "Category III","Category IV"))

nhis_subset_alc_cats$ALCSTAT1 <- factor(nhis_subset_alc_cats$ALCSTAT1,
                                      levels = c(1,2,3),
                                      labels = c("Lifetime abstainer", "Former drinker", "Current drinker"))

## Convert sex to a factor
nhis_subset_alc_cats$SEX <- factor(nhis_subset_alc_cats$SEX,
                                      levels = c(1,2),
                                      labels = c("Male", "Female"))

# Check face validity of new alcohol variables:
nhis_subset_alc_cats %>%
  group_by(alc_4_cats) %>% 
  summarise(mean(alc_daily_g), mean(ALCDAYSYR), mean(ALCAMT), mean(ALC5UPYR))
```

## Review consistancy of alcohol data
Classified as inconsistent if:
a) individuals reporting number of days drinking 5 units+ as more than the total number of days drinking
b) individuals report drinking > 5 drinks on average, but also report never drinking more than 5 drinks

```{r}
# Add column 'inconsistent alc' with a binary variable for whether information is missing or not
data_with_inconsistancies <- nhis_subset_alc_cats %>%
  mutate(inconsistent_alc = if_else(
    ALC5UPYR > ALCDAYSYR | ALC5UPYR ==0 & ALCAMT >= 5, 1, 0))

# Check no abstainers classified as inconsistent
data_with_inconsistancies %>% 
  filter(inconsistent_alc==1) %>% 
  group_by(alc_4_cats) %>% 
  summarise(n())

# Calculate number of drinkers with inconsistent alcohol information and calculate as a % of total drinkers
inconsistent_drinkers_n <- data_with_inconsistancies %>% 
  filter(ALCSTAT1=="Current drinker" & inconsistent_alc==1) %>%
  nrow()

consistent_drinkers_n <- data_with_inconsistancies %>% 
  filter(ALCSTAT1=="Current drinker" & inconsistent_alc==0) %>%
  nrow()

percent_drinkers_inconsistent <- inconsistent_drinkers_n/(inconsistent_drinkers_n + consistent_drinkers_n)*100

# Review patterns of inconsistent data (to check if reasonable to drop)
data_with_inconsistancies %>% 
  filter(ALCSTAT1=="Current drinker" & inconsistent_alc==1) %>%
  group_by(ALCDAYSYR) %>%
  count() %>%
  plot()

data_with_inconsistancies %>% 
  filter(ALCSTAT1=="Current drinker" & inconsistent_alc==1) %>%
  group_by(ALCAMT) %>%
  count() %>%
  plot()

data_with_inconsistancies %>% 
  filter(ALCSTAT1=="Current drinker" & inconsistent_alc==1) %>%
  group_by(ALC5UPYR) %>%
  count() %>%
  plot()
```
Most inconsistencies are for those drinking 364 days a year, those reporting that they drink 5 or 6 drinks on average and those reporting they either never or always drink > 5 units.

## Remove drinkers with incosnstant alcohol data
```{r}
nhis_alc_clean <- data_with_inconsistancies %>% filter(inconsistent_alc==0)
```

# Cap alcohol data
Add a column for alc_daily_g with a cap of 200grams applied
```{r}
nhis_alc_clean <- nhis_alc_clean %>%
    mutate(alc_daily_g_capped_200 = if_else(alc_daily_g > 200, 200, alc_daily_g))
```

Review distribution of alc_daily_grams data (comparing capped and non-capped)
```{r}
# non-capped
nhis_alc_clean %>%
  filter(ALCSTAT1=="Current drinker") %>%
  ggplot(aes(x=alc_daily_g), y) + geom_histogram(bins=400) + xlim(0,200) + ylim(0,30000) + 
ggtitle("Distribution of  estimated alc_daily_g amongst drinkers")
# ggsave("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/plots/alc_grams_data_distribution_drinkers.png", dpi=300, width=33, height=19, units="cm")

# capped
nhis_alc_clean %>%
  filter(ALCSTAT1=="Current drinker") %>%
  ggplot(aes(x=alc_daily_g_capped_200), y) + geom_histogram(bins=400) + xlim(0,201) + ylim(0,30000) + ggtitle("Distribution of estimated alc_daily_g (capped at 200g) amongst drinkers")
# ggsave("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/plots/alc_grams_data_distribution_drinkers_capped.png", dpi=300, width=33, height=19, units="cm")
```
As shown, there is a minimal peak at 200g as a result of the capping, therefore reasonable to assume that capping can be applied to support model fit without loosing a great amount of more detailed consumption data.

# Save datasets:
a) full cleaned dataset
b) drinkers only
```{r}
# a) Save full cleaned data
saveRDS(nhis_alc_clean, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/4_nhis_alc_clean.RDS")

# b) Save subset of drinkers only 
nhis_alc_clean %>%
  filter(ALCSTAT1=="Current drinker") %>%
  saveRDS("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/5_nhis_alc_clean_drinkers_only.RDS")

nhis_alc_clean %>%
  filter(ALCSTAT1=="Current drinker") %>% 
   write_csv("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/nhis_alc_clean_drinkers_only.csv")
```