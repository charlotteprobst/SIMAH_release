---
title: "5_Model_specification"
---

Setup
```{r}
# Load relevant packages
library(tidyr)
library(dplyr)
library(haven)
library(lmtest)
library(car)
library(stargazer)

# Read in transformed data (for drinkers only)
transformed_drinkers <- readRDS("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_log_drinkers.RDS")

transformed_full_sample <- readRDS("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_log_full_sample.RDS")
```


# Check distribution of dependant variable
```{r}
# pre-transformation, drinkers
ggplot(transformed_drinkers, aes(x=alc_daily_g_capped_200), y) + geom_histogram(bins=200) + ggtitle("Distribution of estimated daily grams pre transformation, drinkers only")+ 
  xlim(0,201) + ylim(0,30000) + 
  xlab("Daily grams of alcohol, pre transformation") +
  ylab("Frequency")

# post-transformation, drinkers
ggplot(transformed_drinkers, aes(x=capped_daily_grams_log), y) + geom_histogram(bins=200) + ggtitle("Distribution of estimated daily grams post transformation, drinkers only")+ 
  xlim(-4,6) + ylim(0,30000) + 
  xlab("Daily grams of alcohol, post transformation") +
  ylab("Frequency")

# pre-transformation, full sample
ggplot(transformed_full_sample, aes(x=alc_daily_g_capped_200), y) + geom_histogram(bins=400) + ggtitle("Distribution of estimated daily grams of alcohol amongst NHIS sample adults")+
  xlim(0,201) + ylim(0,17000) + 
  xlab("Daily grams of alcohol, pre-transformation") +
  ylab("Frequency")

# post-transformation,full sample
ggplot(transformed_full_sample, aes(x=capped_daily_grams_log), y) + geom_histogram(bins=400) + ggtitle("Distribution of estimated daily grams post transformation, full sample")+ 
  xlim(-4, 6) + ylim(0,220000) + 
  xlab("Daily grams of alcohol, post transformation") +
  ylab("Frequency")
```

# Not possible to achieve a normal distribution for full sample, therefore continuing grams per day analysis for drinkers only

# Check recommended model specification from a statistical standpoint
```{r}
model_variables <- dplyr::select(transformed_drinkers, capped_daily_grams_log, age_3_cats,age_4_cats,SEX,race_5_cats,education_3_cats,education_4_cats,education_5_cats, birth_cohort, decade)
drinkers_model <- lm(capped_daily_grams_log ~ ., data = model_variables)
step_spec_lr <- stepAIC(drinkers_model, direction = "both")
```
# suggests best model would include:
age_3_cats + age_4_cats + SEX + race_5_cats + education_5_cats + birth_cohort + decade
# However, not appropriate to include more than one age variable or to include age & year & birth cohort.
# Based on exploratory analysis decade seemes more appropriate than birth_cohort.
# Based on intersectional group sizes, 3 age groups more feasible for interpreatble results
# Based on intersectional group sizes, 3 education groups more feasible for interpreatble results

# Specify chosen model
```{r}
model_1 <- lm(capped_daily_grams_log ~ age_3_cats + decade + race_5_cats + education_3_cats + SEX, data = model_variables)
```

# Check assumptions of basic model

### Heteroskedasicty of residuals
```{r}
plot(fitted(model_1), resid(model_1))
abline(h = 0, lty = 2, col = "red")

# standardized residuals
plot(fitted(model_1), rstandard(model_1))
abline(h = 0, lty = 2, col = "red")
```
### Check if residuals normally distributed
```{r}
qqnorm(residuals(model_1))
qqline(residuals(model_1), col = "steelblue", lwd = 2)

qqnorm(rstandard(model_1))
qqline(rstandard(model_1), col = "steelblue", lwd = 2)
```
### Model specification
Ramsey's RESET test for functional form.
H0: that the model has no omitted variables.
```{r}
resettest(model_1, power = 2:3, type = c("fitted", "regressor",
  "princomp"), data = transformed_drinkers)
```
Interpretation: omitted variables likely

### Multicollinearity
Calculate VIF
```{r}
car::vif(model_1)
```
Interpretation: Very low VIF values, suggesting no issues of multicollinearity

Compare predicted_transformed alc_daily_g versus actual transformed alc_daily_g
```{r}
pred_lr_1 <- predict(model_1, interval = 'confidence', type = 'response')
par(mfrow=c(1,2))
hist(pred_lr_1, col = "blue", breaks = 10, xlim=c(-4,8), xlab=("transformed daily grams"), main="modelled data - lr1")
hist(transformed_drinkers$capped_daily_grams_log, col = "blue", breaks = 10, xlim=c(-4,8), xlab=("transformed daily grams"), main="nhis data")
```
