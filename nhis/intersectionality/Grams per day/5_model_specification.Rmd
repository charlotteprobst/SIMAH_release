---
title: "5_Model_specification"
---

Setup
```{r}
# Load relevant packages
library(tidyr)
library(dplyr)
library(haven)
library(lmtest)
library(car)

# Read in transformed data (for drinkers only)
transformed_drinkers <- readRDS("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_log_drinkers.RDS")

transformed_full_sample <- readRDS("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_log_full_sample.RDS")
```
# Display distribution of dependant variable, pre-transformation
```{r}
# pre-transformation, full sample
ggplot(transformed_full_sample, aes(x=alc_daily_g_capped_200), y) + geom_histogram(bins=100) + 
  theme(plot.title = element_text(size=12)) +
  ggtitle("Distribution of daily grams of alcohol amongst NHIS sample adults") +
  xlim(0,100) + ylim(0,50000) + 
  xlab("Daily grams of alcohol, pre-transformation") +
  ylab("Frequency")

# pre-transformation, drinkers
ggplot(transformed_drinkers, aes(x=alc_daily_g_capped_200), y) + geom_histogram() + 
  ggtitle("Distribution of daily grams pre transformation, drinkers only")+ 
  xlim(0,75) + ylim(0,30000) + 
  xlab("Daily grams of alcohol, pre transformation") +
  ylab("Frequency")
```

# Specify a null model based on non-transformed sample and check the assumptions
```{r}
### Full sample
model_1 <- lm(alc_daily_g_capped_200 ~ age_3_cats + decade + race_5_cats + education_3_cats + SEX, data = transformed_full_sample)

# Heteroskedasticity of residuals
plot(fitted(model_1), resid(model_1))
abline(h = 0, lty = 2, col = "red")

# QQ plot
qqnorm(residuals(model_1))
qqline(residuals(model_1), col = "steelblue", lwd = 2)

#### Drinkers only
model_2 <- lm(alc_daily_g_capped_200 ~ age_3_cats + decade + race_5_cats + education_3_cats + SEX, data = transformed_drinkers)

# Heteroskedasticity of residuals
plot(fitted(model_2), resid(model_2))
abline(h = 0, lty = 2, col = "red")

# QQ plot
qqnorm(residuals(model_2))
qqline(residuals(model_2), col = "steelblue", lwd = 2)
```
# ASSUMPTIONS NOT MET WITH NON-TRANSFORMED DATA

# Display distribution of dependant variable, post-transformation
```{r}
# post-transformation,full sample
ggplot(transformed_full_sample, aes(x=capped_daily_grams_log), y) + geom_histogram() + 
  ggtitle("Distribution of estimated daily grams post transformation, full sample")+ 
  xlab("Daily grams of alcohol, post transformation") +
  ylab("Frequency")

# post-transformation, drinkers
ggplot(transformed_drinkers, aes(x=capped_daily_grams_log), y) + geom_histogram(bins=100) + 
  ggtitle("Distribution of daily grams of alcohol amongst drinkers(log-transformed)")+ 
  xlab("Daily grams of alcohol, post transformation") +
  ylab("Frequency")
```

# Specify a null model based on the transformed samples, drinkers only, and check the assumptions
```{r}
## Full sample
model_3 <- lm(capped_daily_grams_log ~ age_3_cats + decade + race_5_cats + education_3_cats + SEX, data = transformed_full_sample)

# Heteroskedasticity of residuals
plot(fitted(model_3), resid(model_3))
abline(h = 0, lty = 2, col = "red")

# QQ plot
qqnorm(residuals(model_3))
qqline(residuals(model_3), col = "steelblue", lwd = 2)


## Drinkers only
model_4 <- lm(capped_daily_grams_log ~ age_3_cats + decade + race_5_cats + education_3_cats + SEX, data = transformed_drinkers)

# Heteroskedasticity of residuals
plot(fitted(model_4), resid(model_4))
abline(h = 0, lty = 2, col = "red")

# QQ plot
qqnorm(residuals(model_4))
qqline(residuals(model_4), col = "steelblue", lwd = 2)
```

# Check further assumptions of chosen model

### Model specification
Ramsey's RESET test for functional form.
H0: that the model has no omitted variables.
```{r}
resettest(model_4, power = 2:3, type = c("fitted", "regressor",
  "princomp"), data = transformed_drinkers)
```
Interpretation: Can reject the null hypothesis i.e. omitted variables likely

### Multicollinearity
Calculate VIF
```{r}
car::vif(model_4)
```
Interpretation: Very low VIF values, suggesting no issues of multicollinearity

Compare predicted_transformed alc_daily_g versus actual transformed alc_daily_g
```{r}
pred_lr_1 <- predict(model_4, interval = 'confidence', type = 'response')
par(mfrow=c(1,2))
hist(pred_lr_1, col = "blue", breaks = 10, xlim=c(-4,8), xlab=("transformed daily grams"), main="modelled data - lr1")
hist(transformed_drinkers$capped_daily_grams_log, col = "blue", breaks = 10, xlim=c(-4,8), xlab=("transformed daily grams"), main="nhis data")
```
