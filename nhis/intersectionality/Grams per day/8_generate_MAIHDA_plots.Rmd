"This script generates takes the data generated by MAIHDA and generates descriptive plots of the results"

Setup
```{r}
## Read in R packages
library(tidyverse)
library(readr)
library(tidyr)
library(dplyr)
library(labelled)
library(haven)
library(ggplot2)
library(forcats)

## Bias toward non-scientific notation
options(scipen=10)

# Set default theme for plots:
theme_set(theme_bw(base_size = 12))
```

Load in data
```{r}
data <- read_rds("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/back_transformed_data_log.rds")
```

Generate columns for race, sex, education and generation (as want them named in the graph) using column intersectional names
```{r}
data <- data %>%
  mutate(sex=ifelse(grepl("F",intersectional_names),"Female","Male"),
         race=ifelse(grepl("Non-Hispanic Asian",intersectional_names),"Asian",
              ifelse(grepl("Non-Hispanic Black", intersectional_names),"Black",
              ifelse(grepl("Non-Hispanic Other", intersectional_names), "Other",
              ifelse(grepl("White", intersectional_names), "White","Hispanic")))),
         education=ifelse(grepl("low edu.", intersectional_names), "low edu.",
              ifelse(grepl("med. edu.", intersectional_names), "medium edu.", "high edu.")),
         education=factor(education,levels=c("low edu.", "medium edu.", "high edu.")))
```

### Plots of residuals (log transformed)
Separate plots for men and women
```{r}
male_residuals_log <- data %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=age_3_cats, y=residuals, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - (1.96*residualsSE),
                    ymax = residuals + (1.96*residualsSE)),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Males: Residuals (log)")
male_residuals_log

female_residuals_log <- data %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=age_3_cats, y=residuals, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = residuals - (1.96*residualsSE),
                    ymax = residuals + (1.96*residualsSE)),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  ggtitle("Females: Residuals (log)")
female_residuals_log
```
# Count number of intersections with CIs that don't include 0
```{r}
interactions <- data %>% 
  mutate(
    ymin = residuals - (1.96*residualsSE),
    ymax = residuals + (1.96*residualsSE),
    sig_resid = case_when(ymin > 0 & ymax > 0 ~ "more",
                          ymin < 0 & ymax < 0 ~ "less", 
                          ymin < 0 & ymax > 0 ~ "expected")
  ) %>%
  filter(sig_resid!="expected") %>%
  select(sex, decade, race, age_3_cats, education, ymin, ymax, sig_resid)
```


### Plots of predicted means and standard errors (log_transformed)

Separate plots for men and women
```{r}
# Plot males
male_grams_log <- data %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=age_3_cats, y=mean, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = mean - (1.96*SE),
                    ymax = mean + (1.96*SE)),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ggtitle("Males: average alcohol consumption split by intersectional groups")+
  labs(y= "log(grams per day)")
male_grams_log

# Plot females
female_grams_log <- data %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=age_3_cats, y=mean, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = mean - (1.96*SE),
                    ymax = mean + (1.96*SE)),
                    position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom")+
  ggtitle("Females: average alcohol consumption split by intersectional groups") +
  labs(y= "log(grams per day)")
female_grams_log
```


# Plots of back transformed data
Residuals after being back transformed
```{r}
male_residuals <- data %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_residual, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_residual_CI_lower,
                    ymax = back_transformed_residual_CI_upper),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=1, linetype="dashed", color = "red") +
  ggtitle("Male Residuals")
male_residuals

female_residuals <- data %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_residual, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_residual_CI_lower,
                    ymax = back_transformed_residual_CI_upper),
                position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  geom_hline(yintercept=1, linetype="dashed", color = "red") +
  ggtitle("Female Residuals")
female_residuals

# nb. intercept at 1 due to back transformation (exp(0) = 1)
# Note patterning identical to transformed data
```

# Plot of estimates on back transformed data
```{r}
# Plot males
male_grams <- data %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_mean, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "right") +
  ylim(0, 8.5) +
  ggtitle("Males: average alcohol consumption split by intersectional groups")+
  labs(y= "grams per day")
male_grams

# Young Hispanic men with high edu. have had the greatest change (increase) across decades

# Plot females
female_grams <- data %>%
  filter(sex=="Female") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_mean, colour=decade)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
  facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "right")+
  ylim(0, 4.5) +
  ggtitle("Females: average alcohol consumption split by intersectional groups") +
  labs(y= "grams per day")
female_grams
```
Plots split by both sex and decade
```{r}
# MALES:
# 2000-2009
plot_4_male <- data %>%
  filter(sex=="Male", decade=="2000-2009") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_mean)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ylim(0, 10) +
  ggtitle("Males: average alcohol consumption split by intersectional groups, 2000-2009")+
  labs(y= "grams per day")
plot_4_male

#2010-2018
plot_5_male <- data %>%
  filter(sex=="Male", decade=="2010-2018") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_mean)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ylim(0, 10) +
  ggtitle("Males: average alcohol consumption split by intersectional groups, 2010-2018")+
  labs(y= "grams per day")
plot_5_male

# FEMALES:
# 2000-2009
plot_4_female <- data %>%
  filter(sex=="Female", decade=="2000-2009") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_mean)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ylim(0, 10) +
  ggtitle("Females: average alcohol consumption split by intersectional groups, 2000-2009")+
  labs(y= "grams per day")
plot_4_female

#2010-2018
plot_5_female <- data %>%
  filter(sex=="Female", decade=="2010-2018") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_mean)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(race)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ylim(0, 10) +
  ggtitle("Females: average alcohol consumption split by intersectional groups, 2010-2018")+
  labs(y= "grams per day")
plot_5_female
# Overall findings:
# There is no change in which group of males is drinking the most (white young high edu men) across decades
# No change in which group of females is drinking the most (white young high edu women) across decades

```
Plots with race as colours instead

```{r}
# Plot males
male_grams_2 <- data %>%
  filter(sex=="Male") %>%
  ggplot(aes(x=age_3_cats, y=back_transformed_mean, colour=race)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(decade)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ylim(0, 9) +
  ggtitle("Males: average alcohol consumption split by intersectional groups")+
  labs(y= "grams per day")
male_grams_2

# Plot females
female_grams_2 <- data %>%
  filter(sex=="Female") %>%
    ggplot(aes(x=age_3_cats, y=back_transformed_mean, colour=race)) +
  geom_point(position=position_dodge(width=0.8)) +
  geom_errorbar(aes(ymin = back_transformed_CI_lower,
                    ymax = back_transformed_CI_upper),
                    position=position_dodge(width=0.8)) +
                facet_grid(cols=vars(education),rows=vars(decade)) +
  theme(axis.title.x = element_blank(), legend.position = "bottom") +
  ylim(0, 4.1) +
  ggtitle("Females: average alcohol consumption split by intersectional groups") +
  labs(y= "grams per day")
female_grams_2
```
Education level has a greater influence on the drinking habits of younger people than older people
In the last decade, education level has had a large influence on the drinking habits of young black, hispanic, other and white groups - but not on young asians.







