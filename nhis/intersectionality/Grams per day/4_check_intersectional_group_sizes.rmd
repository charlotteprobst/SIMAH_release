---
title: "4_check_intersectional_group_sizes"
---

Setup
```{r}
# Load relevant packages
library(tidyr)
library(dplyr)

# Read in transformed data (for drinkers only)
transformed_drinkers <- readRDS("C:/Users/cmp21seb/Documents/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_drinkers_log.RDS")
```

# Check intersectional group sizes with various subgroup splits

Based on basic model (no age or time variable within intersections)
```{r}
# Generate intersections:
data_intersections_50 <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_5_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_50 <- data_intersections_50 %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_5_cats) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_50$count >= 20) # 50 out of 50
```

Including 5 cohorts within otherwise basic model
```{r}
# Generate intersections:
data_intersections_250 <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_5_cats, birth_cohort) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_250 <- data_intersections_250 %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_5_cats, birth_cohort) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_250$count >= 20) 

data_intersections_250 %>% 
  filter(count<=20) %>% 
  group_by(birth_cohort) %>% 
  count() #Majority of groups with small samples are gen_z
```

# Including age and cohort

3 education cats, 3 age cats
```{r}
# Generate intersections:
data_intersections_A <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_3_cats, birth_cohort, age_3_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_A <- data_intersections_A %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_3_cats, birth_cohort, age_3_cats) %>% arrange(count)

# Number of intersectional groups with more than 20 people in the group
sum(data_intersections_A$count >= 20)  
```

3 education cats, 4 age cats
```{r}
# Generate intersections:
data_intersections_B <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_3_cats, birth_cohort, age_4_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_B <- data_intersections_B %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_3_cats, birth_cohort, age_4_cats) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_B$count >= 20)  
```

5 education cats, 3 age cats
```{r}
# Generate intersections:
data_intersections_C <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_5_cats, birth_cohort, age_3_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_C <- data_intersections_C %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_5_cats, birth_cohort, age_3_cats) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_C$count >= 20) 
```

5 education cats, 4 age cats
```{r}
# Generate intersections:
data_intersections_D <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_5_cats, birth_cohort, age_4_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_D <- data_intersections_D %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_5_cats, birth_cohort, age_4_cats) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_D$count >= 20) 
```

# Including age and year...

## 3 education cats, 3 age cats
```{r}
# Generate intersections:
data_intersections_E <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_3_cats, decade, age_3_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_E <- data_intersections_E %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_3_cats, decade, age_3_cats) %>% arrange(intersections)

# % of intersectional groups with more than 20 people in the group
sum(data_intersections_E$count >= 20)/nrow(data_intersections_E)  
```
3 education cats, 4 age cats
```{r}
# Generate intersections:
data_intersections_F <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_3_cats, decade, age_4_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_F <- data_intersections_F %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_3_cats, decade, age_4_cats) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_F$count >= 20)/nrow(data_intersections_F) 
```

5 education cats, 3 age cats
```{r}
# Generate intersections:
data_intersections_G <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_5_cats, decade, age_3_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_G <- data_intersections_G %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_5_cats, decade, age_3_cats) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_G$count >= 20)/nrow(data_intersections_G)
```

5 education cats, 4 age cats
```{r}
# Generate intersections:
data_intersections_H <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_5_cats, decade, age_4_cats) %>% 
  mutate(intersections = cur_group_id())

# Count people in each group
data_intersections_H <- data_intersections_H %>%
  group_by(intersections) %>%
  mutate(count=n()) %>%
  distinct(intersections, .keep_all = TRUE) %>% 
  dplyr::select(intersections, count, SEX, race_5_cats, education_5_cats, decade, age_4_cats) %>%
  arrange(count)

# Number of intersectional groups with less than 20 people in the group
sum(data_intersections_H$count >= 20)/nrow(data_intersections_H)
```

# Save reference table for intersectional split of choice
```{r}
saveRDS(data_intersections_E, "U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/intersections_count.RDS")
```

