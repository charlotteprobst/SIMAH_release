---
title: "MAIHDA grams per day with glme4"
output: html_notebook
---

Setup
```{r, warning=FALSE}
# Load in data
transformed_drinkers <- readRDS("U:/SIMAH/SIMAH_workplace/nhis/intersectionality/cleaned_data/6_nhis_alc_clean_transformed_drinkers_log.RDS")

# Load necessary packages
library(lme4)
library(tidyr)
library(dplyr)

# Bias toward non-scientific notation
options(scipen=10)

# Change file path ONLY IF using Uni desktop
# options(MLwiN_path="C:\\Program Files\\MLwiN v3.01")
```

Generate intersectional groups
```{r}
data_intersections_MAIHDA <- transformed_drinkers %>% 
  group_by(SEX, race_5_cats, education_3_cats, age_3_cats, decade) %>% 
  mutate(intersections = cur_group_id()) %>%
  group_by(intersections) %>%
  mutate(count=n())
```

Create a reference table of the intersectional groups - numbers and names
```{r}
temp <- data_intersections_MAIHDA %>%
  mutate(sex = dplyr::recode(SEX, Male = "M", Female = "F"),
         race_5_cats = dplyr::recode(race_5_cats, 
                                     "Black/African American" = "Black", 
                                     "Hispanic, White" = "Hispanic"),
         education_3_cats = dplyr::recode(education_3_cats, 
                                          "high school or less" = "low edu.", 
                                          "some college" = "med. edu.", 
                                          "4+ years college" = "high edu."))

temp2 <- temp %>% 
  mutate(intersectional_names = as.character(paste(sex, age_3_cats, race_5_cats, education_3_cats, decade)))

MAIHDA_intersections_reference <- distinct(temp2, intersections, .keep_all = TRUE) %>% dplyr::select(intersections, intersectional_names)
```

## Multilevel model, null

Run the null two-level model and calculate the variance partition coefficient (VPC)
```{r}
linear_null <- lmer(capped_daily_grams_log ~ 1 + (1 | intersections),
                       data = data_intersections_MAIHDA,
                       control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(linear_null)
performance::icc(linear_null)
```
# Add in main effects one at a time (i.e. SEX, age_3_cats, race_5_cats, education_3_cats, decade) & recalculate ICC for each model, to see the contribution of each to the overall variance

sex
```{r}
linear_sex <- lmer(capped_daily_grams_log ~ 1 + SEX + (1 | intersections),
                       data = data_intersections_MAIHDA,
                       control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
performance::icc(linear_sex)
```
age_3_cats
```{r}
linear_age <- lmer(capped_daily_grams_log ~ 1 + age_3_cats + (1 | intersections),
                       data = data_intersections_MAIHDA,
                       control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
performance::icc(linear_age_3_cats)
```
race_5_cats
```{r}
linear_race <- lmer(capped_daily_grams_log ~ 1 + race_5_cats + (1 | intersections),
                       data = data_intersections_MAIHDA,
                       control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
performance::icc(linear_race)
```
education_3_cats
```{r}
linear_education <- lmer(capped_daily_grams_log ~ 1 + education_3_cats + (1 | intersections),
                       data = data_intersections_MAIHDA,
                       control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
performance::icc(linear_education)
```
decade
```{r}
linear_decade <- lmer(capped_daily_grams_log ~ 1 + decade + (1 | intersections),
                       data = data_intersections_MAIHDA,
                       control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
performance::icc(linear_decade)
```
# Intersectional model (all main effects)
```{r}
linear_main_effects <- lmer(capped_daily_grams_log ~ 1 + SEX + age_3_cats + race_5_cats + education_3_cats + decade + (1 | intersections),
                       data = data_intersections_MAIHDA,
                       control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))
summary(linear_main_effects)
full_MAIHDA_coefs <- coef(linear_main_effects)
# nb. as shown in this table, each intersectional group has a random intercept that varies by intersectional group and a fixed intercept for each of Sex, age, race, education and decade. 
```
# Store model results
# Estimates (and SEs) using predict function
data_intersections_MAIHDA$yhat <- predict(linear_main_effects) # the predicted expected value
<!-- data_intersections_MAIHDA$yhat_se <- predict(linear_main_effects, se.fit=TRUE) # the standard error of the predicted expected value -->

<!-- # Create table with results for just one intersection -->
<!-- processed_intersections_MAIHDA_MCMC <- distinct(data_intersections_MAIHDA_MCMC, intersections, .keep_all = TRUE) -->

<!-- # Extract residuals from the Mlwin output object -->
<!-- processed_intersections_MAIHDA_MCMC$residuals <- VarCompResidMCMC@residual$lev_2_resi_est_Intercept -->

<!-- # Extract the estimate of variance around the residuals, and take the sqrt of it to get the standard error around the residuals -->
<!-- processed_intersections_MAIHDA_MCMC$residualsSE <- sqrt(VarCompResidMCMC@residual$lev_2_resi_variance_Intercept) # standard error around residuals -->

<!-- # Estimate the CI around the residual -->
<!-- processed_intersections_MAIHDA_MCMC$residual_CI_lower <- processed_intersections_MAIHDA_MCMC$residuals - (1.96*processed_intersections_MAIHDA_MCMC$residualsSE) -->
<!-- processed_intersections_MAIHDA_MCMC$residual_CI_upper <- processed_intersections_MAIHDA_MCMC$residuals + 1.96*processed_intersections_MAIHDA_MCMC$residualsSE -->

<!-- # Estimate the overall mean combining additive effects (main effects) and multiplicative effects (residuals) -->
<!-- processed_intersections_MAIHDA_MCMC <- processed_intersections_MAIHDA_MCMC %>%  -->
<!--   mutate(mean = sum(yhat, residuals)) -->

<!-- # Estimate the total standard error by combining the error around the mean plus the error around the residuals: -->
<!-- processed_intersections_MAIHDA_MCMC <- processed_intersections_MAIHDA_MCMC %>%  -->
<!--   mutate(SE =(sqrt((yhat_se*yhat_se)+(residualsSE*residualsSE)))/2) -->


<!-- # Exploring some simple interaction models -->

<!-- sex*age -->
<!-- ```{r} -->
<!-- interaction_sex_age <- lmer(capped_daily_grams_log ~ 1 + race_5_cats + education_3_cats + decade + SEX*age_3_cats + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_sex_age) -->
<!-- ``` -->
<!-- sex*race -->
<!-- ```{r} -->
<!-- interaction_sex_race <- lmer(capped_daily_grams_log ~ 1 + age_3_cats + education_3_cats + decade + SEX*race_5_cats + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_sex_race) -->
<!-- ``` -->

<!-- sex*education -->
<!-- ```{r} -->
<!-- interaction_sex_education <- lmer(capped_daily_grams_log ~ 1 + age_3_cats + race_5_cats + decade + SEX*education_3_cats + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_sex_education) -->
<!-- ``` -->
<!-- sex*decade -->
<!-- ```{r} -->
<!-- interaction_sex_decade <- lmer(capped_daily_grams_log ~ 1 + age_3_cats + race_5_cats + education_3_cats + SEX*decade + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_sex_decade) -->
<!-- ``` -->

<!-- age*race -->
<!-- ```{r} -->
<!-- interaction_age_race <- lmer(capped_daily_grams_log ~ 1 + SEX + education_3_cats + decade + age_3_cats*race_5_cats + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_age_race) -->
<!-- ``` -->
<!-- age*education -->
<!-- ```{r} -->
<!-- interaction_age_education <- lmer(capped_daily_grams_log ~ 1 + SEX + race_5_cats + decade + age_3_cats*education_3_cats + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_age_education) -->
<!-- ``` -->
<!-- age*decade -->
<!-- ```{r} -->
<!-- interaction_age_decade <- lmer(capped_daily_grams_log ~ 1 + SEX + race_5_cats + education_3_cats + age_3_cats*decade + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_age_decade) -->
<!-- ``` -->
<!-- race*education -->
<!-- ```{r} -->
<!-- interaction_race_education <- lmer(capped_daily_grams_log ~ 1 + SEX + age_3_cats + decade + race_5_cats*education_3_cats + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_race_education) -->
<!-- ``` -->
<!-- race*decade -->
<!-- ```{r} -->
<!-- interaction_sex_decade <- lmer(capped_daily_grams_log ~ 1 + SEX + age_3_cats + education_3_cats + race_5_cats*decade + (1 | intersections), -->
<!--                        data = data_intersections_MAIHDA, -->
<!--                        control=lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))) -->
<!-- performance::icc(interaction_sex_decade) -->
<!-- ``` -->
