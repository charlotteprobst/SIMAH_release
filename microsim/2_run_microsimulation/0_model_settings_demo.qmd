---
title: "Model settings demonstration"
format: html
editor: visual
---

This document goes through each of the functions in the model settings script for the SIMAH microsimulation and explains what each function does - each function can be looked at in detail using the drop down menus.

First set up all of the settings for the simulation run.

```{r}
library(microsimpackage)
library(dplyr)
library(readr)
library(tidyr)

WorkingDirectory <- "~/Google Drive/SIMAH Sheffield/"

set.seed(42)

options(scipen=999)

######################EDIT ONLY BELOW HERE ##################################################

# which geography -  needs to be written as USA or full state name 
SelectedState <- "USA"

# Size of population - needs to be a population size available in the data folder
PopulationSize <- 1000000

# switch on and off migration and deaths
migrationdeaths <- 1

# switch on and off education updates
updatingeducation <- 1

# switch on and off alcohol updates
updatingalcohol <- 1

# switch between modelling mortality and morbidity (mortality = 1)
mortality <- 1

# switch on or off liver cirrhosis modelling
cirrhosis <- 0

# switch between CASCADE and SIMAH versions
model <- "SIMAH"

####################EDIT ONLY ABOVE HERE ##################################################

```

This next section calculates the proportion of the selected geography that is being simulated - to adjust all the other model settings to this sized population

```{r}
# what proportion of the population does this represent
WholePopSize <- read.csv(paste0(WorkingDirectory,"SIMAH_workplace/microsim/1_input_data/fullpopcounts.csv")) %>% 
  filter(STATE==SelectedState)

proportion <- PopulationSize/WholePopSize$total
proportion <- ifelse(proportion>1,1,proportion)
```

## Representative synthetic population

This section reads in the baseline population file - this file should already exist in your data folder.
There are two different versions of the baseline population for the SIMAH (starts in 2000) and CASCADE (starts in 1984) versions of the simulation.

```{r}
# read in base population
if(model=="SIMAH"){
  basepop <- read_csv(paste0(WorkingDirectory,"SIMAH_workplace/microsim/1_input_data/agent_files/", SelectedState, "basepop", PopulationSize, ".csv"),
                      show_col_types = FALSE)
}else if(model=="CASCADE"){
  basepop <- read_csv(paste0(WorkingDirectory,"SIMAH_workplace/microsim/1_input_data/agent_files/", SelectedState, "basepopCASCADE", PopulationSize, ".csv"))
}
# save a copy of original population files
baseorig <- basepop

# set microsim individuals IDs 
microsim.init.id <- 1:nrow(basepop)
basepop <- cbind(microsim.init.id, basepop)
```

This is the first function - reading in the BRFSS data

```{r, file="~/Google Drive/SIMAH Sheffield/SIMAH_code/microsimpackage/R/load_brfss.R"}
#| code-fold: true
#| code-summary: "Function: load_brfss.R"
```

*Note for the purposes of this tutorial - the BRFSS data has been sub-sampled to enable the model to run more quickly*

Use the function to read in the BRFSS data

```{r}
# read in BRFSS data for migrants and 18-year-olds entering the model
brfss <- load_brfss(model,SelectedState,WorkingDirectory)
```

## Add and remove individuals due to births and migration

Function to read in the death rates data

```{r, file="~/Google Drive/SIMAH Sheffield/SIMAH_code/microsimpackage/R/load_death_rates.R"}
#| code-fold: true
#| code-summary: "Function: load_death_rates.R"
```

Use the function to read in death rates data based on CDC data

```{r}
death_rates <- load_death_rates(model, SelectedState, WorkingDirectory)
```

Function to read in the migration in and out rates data

```{r, file="~/Google Drive/SIMAH Sheffield/SIMAH_code/microsimpackage/R/load_migration_rates.R"}
#| code-fold: true
#| code-summary: "Function: load_migration_rates.R"
```

Use the function to read in the migration in and out rates (derived from ACS data)

```{r}
# read in migration in and out rates and project rates forwards to 2025 (in case needed)
migration_rates <- load_migration_rates(SelectedState, WorkingDirectory)
```

## Update education

Function to read in education transitions data and set up the brfss and base population ready for simulating education (imputing a new education level for individuals in the "some college" category based on which year of college they are in (based on ACS data)

```{r, file="~/Google Drive/SIMAH Sheffield/SIMAH_code/microsimpackage/R/load_education_transitions.R"}
#| code-fold: true
#| code-summary: "Function: load_education_transitions.R"
```

Use this function to get education transition probabilities and to modify the BRFSS and base population education.
The output of this function returns a list with 3 components and the following lines of code extract each component

```{r}
# load in the education transition rates
list <- load_education_transitions(SelectedState, basepop, brfss, WorkingDirectory)
education_transitions <- list[[1]]
basepop <- list[[2]]
brfss <- list[[3]]
rm(list)
```

## Update alcohol consumption

Function to read in alcohol transition probabilities and set up the data for transitioning alcohol use (assigning an alcohol use category to base population and BRFSS individuals)

```{r, file="~/Google Drive/SIMAH Sheffield/SIMAH_code/microsimpackage/R/load_alcohol_transitions.R"}
#| code-fold: true
#| code-summary: "Function: load_education_transitions.R"
```

Use this function to generate alcohol transition probabilities and corresponding adjusted data files

```{r}
# load in alcohol transition rates
list <- load_alcohol_transitions(basepop, brfss, WorkingDirectory)
alcohol_transitions <- list[[1]]
basepop <- list[[2]]
brfss <- list[[3]]
rm(list)
```
